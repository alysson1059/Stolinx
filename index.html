<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stolinx - Gerenciador de Estoque</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Sharp" rel="stylesheet">
    <!-- Adicionando a biblioteca de gráficos Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* --- ESTILOS DO SEU MODELO (COM ADIÇÕES PARA O MODAL) --- */
        :root {
            --color-primary: #7380ec;
            --color-danger: #ff7782;
            --color-success: #41f1b6;
            --color-warning: #ffbb55;
            --color-white: #fff;
            --color-info-dark: #7d8da1;
            --color-info-light: #dce1eb;
            --color-dark: #363949;
            --color-light: rgba(132, 139, 200, 0.18);
            --color-primary-variant: #111e88;
            --color-dark-variant: #677483;
            --color-background: #f6f6f9;

            --card-border-radius: 2rem;
            --border-radius-1: 0.4rem;
            --border-radius-2: 0.8rem;
            --border-radius-3: 1.2rem;

            --card-padding: 1.8rem;
            --padding-1: 1.2rem;

            --box-shadow: 0 2rem 3rem var(--color-light);
        }

        * {
            margin: 0;
            padding: 0;
            outline: 0;
            appearance: none;
            border: 0;
            text-decoration: none;
            list-style: none;
            box-sizing: border-box;
        }

        html {
            font-size: 14px;
        }

        body {
            width: 100vw;
            height: 100vh;
            font-family: 'Poppins', sans-serif;
            font-size: 0.88rem;
            background: var(--color-background);
            user-select: none;
            overflow-x: hidden;
            color: var(--color-dark);
        }

        .container {
            display: grid;
            width: 96%;
            margin: 0 auto;
            gap: 1.8rem;
            grid-template-columns: 14rem auto;
        }

        a {
            color: var(--color-dark);
        }

        h1 {
            font-weight: 800;
            font-size: 1.8rem;
        }

        h2 {
            font-size: 1.4rem;
        }
        
        h3 {
            font-size: 0.87rem;
        }

        /* --- Sidebar --- */
        aside {
            height: 100vh;
        }

        aside .top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 1.4rem;
        }

        aside .logo {
            display: flex;
            gap: 0.8rem;
        }

        aside .logo h2 {
            font-weight: 800;
        }
        
        aside .logo h2 .danger {
            color: var(--color-danger);
        }

        aside .sidebar {
            display: flex;
            flex-direction: column;
            height: 86vh;
            position: relative;
            top: 3rem;
        }

        aside h3 {
            font-weight: 500;
        }

        aside .sidebar a {
            display: flex;
            color: var(--color-info-dark);
            margin-left: 2rem;
            gap: 1rem;
            align-items: center;
            position: relative;
            height: 3.7rem;
            transition: all 300ms ease;
        }

        aside .sidebar a span {
            font-size: 1.6rem;
            transition: all 300ms ease;
        }
        
        aside .sidebar a:last-child {
            position: absolute;
            bottom: 2rem;
            width: 100%;
        }

        aside .sidebar a.active {
            background: var(--color-light);
            color: var(--color-primary);
            margin-left: 0;
        }

        aside .sidebar a.active:before {
            content: '';
            width: 6px;
            height: 100%;
            background: var(--color-primary);
        }
        
        aside .sidebar a.active span {
            color: var(--color-primary);
        }

        aside .sidebar a:hover {
            color: var(--color-primary);
        }

        aside .sidebar a:hover span {
            margin-left: 1rem;
        }
        
        /* --- Main Content --- */
        main {
            margin-top: 1.4rem;
        }
        
        .main-content {
            display: none;
        }

        .main-content.active {
            display: block;
        }
        
        main .date {
            display: inline-block;
            background: var(--color-light);
            border-radius: var(--border-radius-1);
            margin-top: 1rem;
            padding: 0.5rem 1.6rem;
        }
        
        main .insights {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.6rem;
        }
        
        main .insights > div {
            background: var(--color-white);
            padding: var(--card-padding);
            border-radius: var(--card-border-radius);
            margin-top: 1rem;
            box-shadow: var(--box-shadow);
            transition: all 300ms ease;
        }

        main .insights > div:hover {
            box-shadow: none;
        }

        main .insights > div span {
            background: var(--color-primary);
            padding: 0.5rem;
            border-radius: 50%;
            color: var(--color-white);
            font-size: 2rem;
        }

        main .insights > div.sales span { background: var(--color-success); }
        main .insights > div.expenses span { background: var(--color-danger); }
        main .insights > div.income span { background: var(--color-primary); }


        main .insights > div .middle {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        main .insights h3 {
            margin: 1rem 0 0.6rem;
            font-size: 1rem;
        }

        .text-muted {
            color: var(--color-info-dark);
        }
        
        /* --- Gráficos e Tabelas --- */
        .card {
            background: var(--color-white);
            padding: var(--card-padding);
            border-radius: var(--card-border-radius);
            box-shadow: var(--box-shadow);
            transition: all 300ms ease;
            margin-top: 1.5rem;
        }

        .card:hover {
            box-shadow: none;
        }
        
        .card h2 {
            margin-bottom: 1.2rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--color-light);
        }
        
        tbody tr:last-child td {
            border: none;
        }
        
        .low-stock-warning {
            color: var(--color-warning);
            font-weight: bold;
        }
        
        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.6rem;
            align-items: start;
        }

        .dashboard-grid .card {
            margin-top: 0;
        }

        /* [NOVO] Estilo para controlar o tamanho do gráfico */
        .chart-container {
            position: relative;
            height: 300px; /* Altura máxima do gráfico */
            width: 100%;
        }

        /* --- Formulários --- */
        .form-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .input-group label {
            font-weight: 500;
        }

        input, select {
            width: 100%;
            padding: 10px;
            border-radius: var(--border-radius-1);
            background: var(--color-light);
            font-family: 'Poppins', sans-serif;
            color: var(--color-dark);
            font-size: 0.88rem;
        }
        
        button {
            padding: 10px 20px;
            border-radius: var(--border-radius-1);
            background: var(--color-primary);
            color: var(--color-white);
            cursor: pointer;
            transition: all 300ms ease;
            font-family: 'Poppins', sans-serif;
            font-size: 0.9rem;
            width: 100%;
        }
        
        button:hover {
            opacity: 0.8;
        }
        
        .btn-success { background: var(--color-success); }
        .btn-danger { background: var(--color-danger); }
        .btn-warning { background: var(--color-warning); }
        
        .action-buttons button {
            margin-right: 5px;
            padding: 5px 8px;
            width: auto;
        }

        .action-buttons .material-icons-sharp {
            font-size: 1.2rem;
            vertical-align: middle;
        }

        .search-bar {
            width: 100%;
            margin-bottom: 1.5rem;
        }

        /* ESTILOS PARA O MODAL DE CATEGORIAS */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: none; /* Escondido por padrão */
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-container {
            background: var(--color-white);
            padding: var(--card-padding);
            border-radius: var(--card-border-radius);
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--color-light);
            padding-bottom: 1rem;
            margin-bottom: 1.5rem;
        }

        .modal-header h2 {
            margin: 0;
        }

        .modal-header .close-modal {
            background: none;
            color: var(--color-dark);
            font-size: 2rem;
            cursor: pointer;
            padding: 0;
            width: auto;
        }

        #lista-categorias li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 5px;
            border-bottom: 1px solid var(--color-light);
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- ========== SIDEBAR ========== -->
        <aside>
            <div class="top">
                <div class="logo">
                    <h2>STOL<span class="danger">INX</span></h2>
                </div>
            </div>

            <div class="sidebar">
                <a href="#" class="nav-link active" data-target="dashboard">
                    <span class="material-icons-sharp">grid_view</span>
                    <h3>Dashboard</h3>
                </a>
                <a href="#" class="nav-link" data-target="estoque">
                    <span class="material-icons-sharp">inventory_2</span>
                    <h3>Estoque</h3>
                </a>
                <a href="#" class="nav-link" data-target="vendas">
                    <span class="material-icons-sharp">receipt_long</span>
                    <h3>Vendas</h3>
                </a>
                <a href="#">
                    <span class="material-icons-sharp">logout</span>
                    <h3>Sair</h3>
                </a>
            </div>
        </aside>

        <!-- ========== MAIN CONTENT ========== -->
        <main>
            <!-- ========== DASHBOARD ========== -->
            <div id="dashboard" class="main-content active">
                <h1>Dashboard</h1>
                <div class="date" id="current-date">Carregando data...</div>

                <div class="insights">
                    <div class="sales">
                        <span class="material-icons-sharp">analytics</span>
                        <div class="middle">
                            <div>
                                <h3>Faturamento do Mês</h3>
                                <h1 id="faturamento-mes">R$ 0,00</h1>
                            </div>
                        </div>
                        <small class="text-muted">Aguardando vendas</small>
                    </div>
                    <div class="expenses">
                        <span class="material-icons-sharp">bar_chart</span>
                        <div class="middle">
                           <div>
                                <h3>Investimento (Custo Total)</h3>
                                <h1 id="investimento-mes">R$ 0,00</h1>
                           </div>
                        </div>
                        <small class="text-muted">Soma do custo do estoque</small>
                    </div>
                    <div class="income">
                        <span class="material-icons-sharp">stacked_line_chart</span>
                        <div class="middle">
                            <div>
                                <h3>Lucro Potencial</h3>
                                <h1 id="lucro-mes">R$ 0,00</h1>
                            </div>
                        </div>
                        <small class="text-muted">Total de venda - Custo total</small>
                    </div>
                </div>

                <!-- Novo container para o grid do dashboard -->
                <div class="dashboard-grid" style="margin-top: 1.5rem;">
                    <div class="card">
                        <h2>Vendas por Produto (Unidades no Mês)</h2>
                        <!-- [ALTERADO] Canvas envolvido por um container com altura fixa -->
                        <div class="chart-container">
                            <canvas id="salesChart"></canvas>
                        </div>
                    </div>
                     <div class="card">
                        <h2>Produtos com Mais Saída</h2>
                        <table>
                            <thead>
                                <tr>
                                    <th>Produto</th>
                                    <th>Unidades Vendidas</th>
                                </tr>
                            </thead>
                            <tbody id="produtos-mais-saida-body">
                                <tr><td colspan="2">Nenhuma venda registrada ainda.</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- ========== ESTOQUE ========== -->
            <div id="estoque" class="main-content">
                <h1>Gerenciar Estoque</h1>
                <div class="card">
                    <h2>Cadastrar Novo Item</h2>
                    <form class="form-container" id="form-cadastro-produto">
                        <div class="input-group">
                            <label for="codigoProduto">Código do Produto</label>
                            <input type="text" id="codigoProduto" placeholder="Ex: SB001" required>
                        </div>
                        <div class="input-group">
                            <label for="nomeProduto">Nome do Produto</label>
                            <input type="text" id="nomeProduto" placeholder="Ex: Sabonete Líquido" required>
                        </div>
                        <div class="input-group">
                            <label for="validade">Validade</label>
                            <input type="date" id="validade">
                        </div>
                        <div class="input-group">
                            <label for="quantidade">Quantidade</label>
                            <input type="number" id="quantidade" placeholder="Ex: 50" required>
                        </div>
                        <div class="input-group">
                            <label for="custoProduto">Custo do Produto</label>
                            <input type="text" class="currency" id="custoProduto" placeholder="Digite o valor" required>
                        </div>
                        <div class="input-group">
                            <label for="valorVenda">Valor de Venda</label>
                            <input type="text" class="currency" id="valorVenda" placeholder="Digite o valor" required>
                        </div>
                        <div class="input-group">
                            <label for="categoria">Categoria</label>
                            <div style="display: flex; gap: 10px;">
                                <select id="categoria" style="flex-grow: 1;">
                                    <!-- Categorias do Firebase virão aqui -->
                                </select>
                                <button type="button" id="open-category-modal" class="btn-warning" style="width: auto; padding: 0 15px;">
                                    <span class="material-icons-sharp">settings</span>
                                </button>
                            </div>
                        </div>
                        <div class="input-group" style="justify-content: flex-end;">
                            <button type="submit" class="btn-success">Cadastrar Produto</button>
                        </div>
                    </form>
                </div>
                
                <div class="card">
                    <h2>Itens em Estoque</h2>
                    <input type="text" class="search-bar" id="searchEstoque" placeholder="Pesquisar por nome ou código...">
                    <table>
                        <thead>
                            <tr>
                                <th>Código</th>
                                <th>Produto</th>
                                <th>Qtd.</th>
                                <th>Custo</th>
                                <th>Venda</th>
                                <th>Lucro/Un.</th>
                                <th>Ações</th>
                            </tr>
                        </thead>
                        <tbody id="tabela-estoque-body">
                            <!-- Os dados do Firebase serão inseridos aqui -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- ========== VENDAS ========== -->
            <div id="vendas" class="main-content">
                <h1>Registrar Venda / Orçamento</h1>
                <div class="card">
                    <h2>Itens e Cliente</h2>
                    <div class="form-container">
                        <div class="input-group" style="grid-column: 1 / -1;">
                            <label for="nomeCliente">Nome do Cliente</label>
                            <input type="text" id="nomeCliente" placeholder="Opcional">
                        </div>
                        
                        <div class="input-group">
                            <label for="selectProdutoVenda">Adicionar Produto</label>
                            <select id="selectProdutoVenda">
                                <option value="">Cadastre um item no estoque primeiro</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="quantidadeVenda">Quantidade</label>
                            <input type="number" id="quantidadeVenda" value="1" min="1">
                        </div>
                        
                        <div class="input-group" style="grid-column: 1 / -1;">
                             <button type="button" id="addItemOrcamento" style="width: auto; padding: 10px 30px;">Adicionar ao Orçamento</button>
                        </div>
                    </div>
                    
                    <h2 style="margin-top: 2rem;">Orçamento Atual</h2>
                     <table>
                        <thead>
                            <tr>
                                <th>Produto</th>
                                <th>Qtd.</th>
                                <th>Preço Unit.</th>
                                <th>Subtotal</th>
                                <th>Ação</th>
                            </tr>
                        </thead>
                        <tbody id="orcamento-body">
                            <!-- Itens do orçamento/venda aqui -->
                        </tbody>
                    </table>

                    <div style="text-align: right; margin-top: 1.5rem;">
                        <h3>Subtotal: <span id="subtotal-venda">R$ 0,00</span></h3>
                        <div style="display:inline-flex; align-items: center; gap: 10px; margin-top: 1rem;">
                            <label for="descontoVenda">Desconto (R$):</label>
                            <input type="text" class="currency" id="descontoVenda" style="width: 150px;" placeholder="0,00">
                        </div>
                        <h1 style="margin-top: 1rem;">Total: <span id="total-venda">R$ 0,00</span></h1>
                    </div>
                </div>

                <div class="card">
                    <h2>Finalizar</h2>
                    <div class="form-container">
                        <div class="input-group">
                            <label for="dataVenda">Data da Venda</label>
                            <input type="text" id="dataVenda" readonly>
                        </div>
                        <div class="input-group">
                            <label>Ações</label>
                            <div style="display: flex; gap: 1rem;">
                               <button type="button" id="share-whatsapp" style="background-color: #25D366; display:flex; align-items: center; justify-content: center; gap: 0.5rem;">
                                    <span class="material-icons-sharp">share</span> WhatsApp
                                </button>
                                <button type="button" id="registrar-venda-btn" class="btn-success" style="display:flex; align-items: center; justify-content: center; gap: 0.5rem;">
                                    <span class="material-icons-sharp">check_circle</span> Registrar Venda
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- CARD HISTÓRICO DE VENDAS -->
                <div class="card">
                    <h2>Histórico de Vendas</h2>
                    <input type="text" class="search-bar" id="pesquisa-venda-cliente" placeholder="Pesquisar por nome do cliente...">
                    <table>
                        <thead>
                            <tr>
                                <th>Cliente</th>
                                <th>Data</th>
                                <th>Itens Vendidos</th>
                                <th>Valor Total</th>
                            </tr>
                        </thead>
                        <tbody id="historico-vendas-body">
                            <!-- Histórico de vendas do Firebase virá aqui -->
                        </tbody>
                    </table>
                </div>

            </div>
        </main>
    </div>

    <!-- MODAL PARA GERENCIAR CATEGORIAS -->
    <div class="modal-overlay" id="category-modal">
        <div class="modal-container">
            <div class="modal-header">
                <h2>Gerenciar Categorias</h2>
                <button class="close-modal" id="close-category-modal">
                    <span class="material-icons-sharp">close</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <label for="nova-categoria-nome">Adicionar Nova Categoria</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="nova-categoria-nome" placeholder="Nome da Categoria">
                        <button id="add-categoria-btn" class="btn-success" style="width: auto;">Adicionar</button>
                    </div>
                </div>
                <h3 style="margin-top: 2rem; margin-bottom: 1rem;">Categorias Existentes</h3>
                <ul id="lista-categorias">
                    <!-- Lista de categorias do Firebase virá aqui -->
                </ul>
            </div>
        </div>
    </div>


    <!-- SCRIPTS DO FIREBASE -->
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
        // ==========================================================
        //  CONFIGURAÇÃO DO FIREBASE (SEUS DADOS REAIS)
        // ==========================================================
        const firebaseConfig = {
            apiKey: "AIzaSyAv54tgJ5oYrwTSNXpB2rCGjNbhJhe2CoM",
            authDomain: "stolinx-d6e26.firebaseapp.com",
            projectId: "stolinx-d6e26",
            storageBucket: "stolinx-d6e26.appspot.com",
            messagingSenderId: "715535971682",
            appId: "1:715535971682:web:66620d1590ae3e4ba6a83b"
        };

        // Inicializar o Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();

        // ==========================================================
        //  LÓGICA DO APLICATIVO
        // ==========================================================
        document.addEventListener('DOMContentLoaded', () => {
            
            // --- NAVEGAÇÃO ENTRE ABAS ---
            const navLinks = document.querySelectorAll('.nav-link');
            const contentSections = document.querySelectorAll('.main-content');
            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetId = link.getAttribute('data-target');
                    if (!targetId) return;

                    navLinks.forEach(l => l.classList.remove('active'));
                    contentSections.forEach(s => s.classList.remove('active'));
                    
                    link.classList.add('active');
                    document.getElementById(targetId).classList.add('active');
                });
            });

            // --- FUNÇÕES DE FORMATAÇÃO E DATA ---
            function setCurrentDate() {
                const today = new Date();
                const options = { year: 'numeric', month: 'long', day: 'numeric' };
                document.getElementById('current-date').textContent = today.toLocaleDateString('pt-BR', options);
                document.getElementById('dataVenda').value = today.toLocaleDateString('pt-BR');
            }

            function formatCurrency(input) {
                let value = input.value.replace(/\D/g, '');
                if (value === "") {
                    input.value = "";
                    return;
                }
                value = (parseInt(value, 10) / 100).toLocaleString('pt-BR', { minimumFractionDigits: 2 });
                input.value = value;
            }
            
            document.querySelectorAll('.currency').forEach(input => {
                input.addEventListener('input', () => formatCurrency(input));
            });
            
            // --- LÓGICA DO MODAL DE CATEGORIAS ---
            const categoryModal = document.getElementById('category-modal');
            const openModalBtn = document.getElementById('open-category-modal');
            const closeModalBtn = document.getElementById('close-category-modal');
            const addCategoriaBtn = document.getElementById('add-categoria-btn');

            openModalBtn.addEventListener('click', () => {
                categoryModal.style.display = 'flex';
            });
            closeModalBtn.addEventListener('click', () => {
                categoryModal.style.display = 'none';
            });
            categoryModal.addEventListener('click', (e) => {
                if (e.target === categoryModal) {
                    categoryModal.style.display = 'none';
                }
            });

            addCategoriaBtn.addEventListener('click', () => {
                const nomeInput = document.getElementById('nova-categoria-nome');
                const nomeCategoria = nomeInput.value.trim();

                if (nomeCategoria === "") {
                    alert('Por favor, digite um nome para a categoria.');
                    return;
                }

                db.collection("categorias").add({
                    nome: nomeCategoria
                }).then(() => {
                    nomeInput.value = "";
                }).catch(error => {
                    console.error("Erro ao adicionar categoria: ", error);
                });
            });


            // --- FUNÇÕES DO FIREBASE (ESTOQUE) ---
            const formCadastro = document.getElementById('form-cadastro-produto');
            formCadastro.addEventListener('submit', (e) => {
                e.preventDefault();

                const produto = {
                    codigo: formCadastro.codigoProduto.value,
                    nome: formCadastro.nomeProduto.value,
                    validade: formCadastro.validade.value,
                    quantidade: parseInt(formCadastro.quantidade.value),
                    custo: parseFloat(formCadastro.custoProduto.value.replace(/\./g, '').replace(',', '.')),
                    valorVenda: parseFloat(formCadastro.valorVenda.value.replace(/\./g, '').replace(',', '.')),
                    categoria: formCadastro.categoria.value,
                };
                produto.lucroUnidade = produto.valorVenda - produto.custo;

                db.collection("produtos").add(produto)
                .then(() => {
                    alert("Produto cadastrado com sucesso!");
                    formCadastro.reset();
                })
                .catch((error) => {
                    console.error("Erro ao cadastrar: ", error);
                    alert("Falha ao cadastrar produto.");
                });
            });

            // --- FUNÇÕES DE CARREGAMENTO (PRODUTOS E CATEGORIAS) ---
            function carregarCategorias() {
                const selectCategoria = document.getElementById('categoria');
                const listaCategoriasUl = document.getElementById('lista-categorias');

                db.collection("categorias").orderBy("nome").onSnapshot(snapshot => {
                    selectCategoria.innerHTML = "";
                    listaCategoriasUl.innerHTML = "";

                    if (snapshot.empty) {
                        selectCategoria.innerHTML = '<option>Nenhuma categoria</option>';
                        listaCategoriasUl.innerHTML = '<li>Nenhuma categoria cadastrada.</li>';
                        return;
                    }

                    snapshot.forEach(doc => {
                        const categoria = doc.data();
                        const option = document.createElement('option');
                        option.value = categoria.nome;
                        option.textContent = categoria.nome;
                        selectCategoria.appendChild(option);

                        const li = document.createElement('li');
                        li.innerHTML = `
                            <span>${categoria.nome}</span>
                            <div class="action-buttons">
                                <button class="btn-danger" onclick="window.excluirCategoria('${doc.id}', '${categoria.nome}')">
                                    <span class="material-icons-sharp">delete</span>
                                </button>
                            </div>
                        `;
                        listaCategoriasUl.appendChild(li);
                    });
                });
            }
            
            window.excluirCategoria = (id, nome) => {
                if (confirm(`Tem certeza que deseja excluir a categoria "${nome}"?`)) {
                    db.collection("categorias").doc(id).delete().catch(error => {
                        console.error("Erro ao excluir categoria: ", error);
                    });
                }
            }


            function carregarProdutos() {
                const tabelaCorpo = document.getElementById("tabela-estoque-body");
                const selectVenda = document.getElementById('selectProdutoVenda');

                db.collection("produtos").orderBy("nome").onSnapshot((querySnapshot) => {
                    tabelaCorpo.innerHTML = '';
                    selectVenda.innerHTML = '<option value="">Selecione um item do estoque</option>';
                    
                    if (querySnapshot.empty) {
                        tabelaCorpo.innerHTML = '<tr><td colspan="7">Nenhum produto cadastrado.</td></tr>';
                        return;
                    }

                    querySnapshot.forEach((doc) => {
                        const produto = doc.data();
                        const lucroUnidade = produto.lucroUnidade || (produto.valorVenda - produto.custo);
                        const tr = document.createElement('tr');
                        
                        tr.innerHTML = `
                            <td>${produto.codigo}</td>
                            <td>${produto.nome}</td>
                            <td class="${produto.quantidade < 3 ? 'low-stock-warning' : ''}">${produto.quantidade} ${produto.quantidade < 3 ? ' (Repor!)' : ''}</td>
                            <td>R$ ${produto.custo.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                            <td>R$ ${produto.valorVenda.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                            <td>R$ ${lucroUnidade.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                            <td class="action-buttons">
                                <button class="btn-warning"><span class="material-icons-sharp">edit</span></button>
                                <button class="btn-danger" onclick="window.excluirProduto('${doc.id}', '${produto.nome}')"><span class="material-icons-sharp">delete</span></button>
                            </td>
                        `;
                        tabelaCorpo.appendChild(tr);

                        if (produto.quantidade > 0) {
                            const option = document.createElement('option');
                            option.value = doc.id;
                            option.textContent = `${produto.nome} (Estoque: ${produto.quantidade}) - R$ ${produto.valorVenda.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                            option.dataset.price = produto.valorVenda;
                            option.dataset.name = produto.nome;
                            selectVenda.appendChild(option);
                        }
                    });
                });
            }

            window.excluirProduto = (id, nome) => {
                if (confirm(`Tem certeza que deseja excluir o produto "${nome}"?`)) {
                    db.collection("produtos").doc(id).delete().then(() => {
                        alert("Produto excluído com sucesso!");
                    }).catch((error) => {
                        console.error("Erro ao excluir: ", error);
                        alert("Falha ao excluir produto.");
                    });
                }
            }

            // --- LÓGICA DE VENDAS / ORÇAMENTO ---
            let orcamento = [];
            const btnRegistrarVenda = document.getElementById('registrar-venda-btn');

            document.getElementById('addItemOrcamento').addEventListener('click', () => {
                const select = document.getElementById('selectProdutoVenda');
                const produtoId = select.value;
                if (!produtoId) return;

                const selectedOption = select.options[select.selectedIndex];
                const produtoNome = selectedOption.dataset.name;
                const produtoPreco = parseFloat(selectedOption.dataset.price);
                const quantidade = parseInt(document.getElementById('quantidadeVenda').value);

                orcamento.push({ id: produtoId, nome: produtoNome, qtd: quantidade, preco: produtoPreco });
                atualizarTabelaOrcamento();
            });
            
            function atualizarTabelaOrcamento() {
                const orcamentoBody = document.getElementById('orcamento-body');
                orcamentoBody.innerHTML = '';
                let subtotal = 0;

                orcamento.forEach((item, index) => {
                    const itemSubtotal = item.qtd * item.preco;
                    subtotal += itemSubtotal;
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${item.nome}</td>
                        <td>${item.qtd}</td>
                        <td>R$ ${item.preco.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                        <td>R$ ${itemSubtotal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                        <td class="action-buttons">
                            <button class="btn-danger" onclick="window.removerItemOrcamento(${index})"><span class="material-icons-sharp">close</span></button>
                        </td>
                    `;
                    orcamentoBody.appendChild(tr);
                });

                const descontoInput = document.getElementById('descontoVenda');
                const descontoValor = parseFloat(descontoInput.value.replace(/\./g, '').replace(',', '.')) || 0;
                const total = subtotal - descontoValor;

                document.getElementById('subtotal-venda').textContent = `R$ ${subtotal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                document.getElementById('total-venda').textContent = `R$ ${total.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            }

            window.removerItemOrcamento = (index) => {
                orcamento.splice(index, 1);
                atualizarTabelaOrcamento();
            }
            
            document.getElementById('descontoVenda').addEventListener('input', atualizarTabelaOrcamento);

            document.getElementById('share-whatsapp').addEventListener('click', () => {
                if (orcamento.length === 0) {
                    alert('Adicione pelo menos um item ao orçamento para compartilhar.');
                    return;
                }
                let cliente = document.getElementById('nomeCliente').value || 'Cliente';
                let total = document.getElementById('total-venda').innerText;
                
                let texto = `*Orçamento para ${cliente}*\n\n`;
                orcamento.forEach(item => {
                    texto += `- ${item.qtd}x ${item.nome}: R$ ${(item.qtd * item.preco).toLocaleString('pt-BR', {minimumFractionDigits: 2})}\n`;
                });
                texto += `\n*Total: ${total}*`;

                const url = `https://wa.me/?text=${encodeURIComponent(texto)}`;
                window.open(url, '_blank');
            });

            btnRegistrarVenda.addEventListener('click', () => {
                if (orcamento.length === 0) {
                    alert('Adicione pelo menos um item para registrar a venda.');
                    return;
                }

                const venda = {
                    cliente: document.getElementById('nomeCliente').value || 'Não informado',
                    data: firebase.firestore.FieldValue.serverTimestamp(),
                    itens: orcamento,
                    subtotal: parseFloat(document.getElementById('subtotal-venda').textContent.replace('R$ ', '').replace(/\./g, '').replace(',', '.')),
                    desconto: parseFloat(document.getElementById('descontoVenda').value.replace(/\./g, '').replace(',', '.')) || 0,
                    total: parseFloat(document.getElementById('total-venda').textContent.replace('R$ ', '').replace(/\./g, '').replace(',', '.'))
                };

                const batch = db.batch();
                const vendaRef = db.collection('vendas').doc();
                batch.set(vendaRef, venda);

                orcamento.forEach(item => {
                    const produtoRef = db.collection('produtos').doc(item.id);
                    batch.update(produtoRef, {
                        quantidade: firebase.firestore.FieldValue.increment(-item.qtd)
                    });
                });

                batch.commit().then(() => {
                    alert('Venda registrada com sucesso!');
                    orcamento = [];
                    document.getElementById('nomeCliente').value = '';
                    document.getElementById('descontoVenda').value = '';
                    atualizarTabelaOrcamento();
                }).catch(error => {
                    console.error('Erro ao registrar a venda: ', error);
                    alert('Ocorreu um erro ao registrar a venda. Verifique o console para mais detalhes.');
                });
            });

            // --- LÓGICA DO HISTÓRICO DE VENDAS ---
            const pesquisaVendaInput = document.getElementById('pesquisa-venda-cliente');
            let todasAsVendas = [];

            function carregarHistoricoVendas() {
                db.collection('vendas').onSnapshot(snapshot => {
                    todasAsVendas = [];
                    snapshot.forEach(doc => {
                        todasAsVendas.push(doc.data());
                    });

                    todasAsVendas.sort((a, b) => {
                        const dateA = a.data ? a.data.toMillis() : 0;
                        const dateB = b.data ? b.data.toMillis() : 0;
                        return dateB - dateA;
                    });

                    renderizarVendas(todasAsVendas);
                }, error => {
                    console.error("Erro ao carregar histórico de vendas: ", error);
                });
            }

            function renderizarVendas(vendasParaRenderizar) {
                const tabelaCorpo = document.getElementById('historico-vendas-body');
                tabelaCorpo.innerHTML = '';

                if (vendasParaRenderizar.length === 0) {
                    tabelaCorpo.innerHTML = '<tr><td colspan="4">Nenhuma venda encontrada.</td></tr>';
                    return;
                }

                vendasParaRenderizar.forEach(venda => {
                    const tr = document.createElement('tr');
                    let dataFormatada = 'Processando...';
                    if (venda.data && venda.data.toDate) {
                        dataFormatada = venda.data.toDate().toLocaleDateString('pt-BR');
                    }
                    const itensFormatados = venda.itens.map(item => `${item.qtd}x ${item.nome}`).join(', ');
                    
                    tr.innerHTML = `
                        <td>${venda.cliente}</td>
                        <td>${dataFormatada}</td>
                        <td>${itensFormatados}</td>
                        <td>R$ ${venda.total.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                    `;
                    tabelaCorpo.appendChild(tr);
                });
            }
            
            pesquisaVendaInput.addEventListener('input', () => {
                const termoBusca = pesquisaVendaInput.value.toLowerCase().trim();
                if (termoBusca === '') {
                    renderizarVendas(todasAsVendas);
                } else {
                    const vendasFiltradas = todasAsVendas.filter(venda => 
                        venda.cliente.toLowerCase().includes(termoBusca)
                    );
                    renderizarVendas(vendasFiltradas);
                }
            });

            // --- LÓGICA DO DASHBOARD ---
            let salesChartInstance;
            function atualizarDashboard() {
                const faturamentoEl = document.getElementById('faturamento-mes');
                const investimentoEl = document.getElementById('investimento-mes');
                const lucroEl = document.getElementById('lucro-mes');
                const topSellersBody = document.getElementById('produtos-mais-saida-body');

                db.collection('produtos').onSnapshot(snapshot => {
                    let investimentoTotal = 0;
                    let lucroPotencial = 0;
                    snapshot.forEach(doc => {
                        const p = doc.data();
                        investimentoTotal += p.custo * p.quantidade;
                        lucroPotencial += (p.valorVenda - p.custo) * p.quantidade;
                    });
                    investimentoEl.textContent = `R$ ${investimentoTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                    lucroEl.textContent = `R$ ${lucroPotencial.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                });

                db.collection('vendas').onSnapshot(snapshot => {
                    let faturamentoMensal = 0;
                    const hoje = new Date();
                    const mesAtual = hoje.getMonth();
                    const anoAtual = hoje.getFullYear();
                    
                    const topSellers = {};

                    snapshot.forEach(doc => {
                        const v = doc.data();
                        if (v.data && v.data.toDate) {
                            const dataVenda = v.data.toDate();
                            if (dataVenda.getMonth() === mesAtual && dataVenda.getFullYear() === anoAtual) {
                                faturamentoMensal += v.total;
                                v.itens.forEach(item => {
                                    topSellers[item.nome] = (topSellers[item.nome] || 0) + item.qtd;
                                });
                            }
                        }
                    });
                    faturamentoEl.textContent = `R$ ${faturamentoMensal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;

                    const sortedTopSellers = Object.entries(topSellers).sort((a, b) => b[1] - a[1]);
                    
                    topSellersBody.innerHTML = '';
                    if (sortedTopSellers.length === 0) {
                        topSellersBody.innerHTML = '<tr><td colspan="2">Nenhuma venda este mês.</td></tr>';
                    } else {
                        sortedTopSellers.slice(0, 5).forEach(([nome, quantidade]) => {
                            const tr = document.createElement('tr');
                            tr.innerHTML = `<td>${nome}</td><td>${quantidade}</td>`;
                            topSellersBody.appendChild(tr);
                        });
                    }
                    renderProductPieChart(sortedTopSellers);
                });
            }
            
            function renderProductPieChart(topSellersData) {
                const ctx = document.getElementById('salesChart').getContext('2d');
                
                const labels = topSellersData.map(item => item[0]);
                const data = topSellersData.map(item => item[1]);

                if (salesChartInstance) {
                    salesChartInstance.destroy();
                }

                salesChartInstance = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Unidades Vendidas',
                            data: data,
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.7)',
                                'rgba(54, 162, 235, 0.7)',
                                'rgba(255, 206, 86, 0.7)',
                                'rgba(75, 192, 192, 0.7)',
                                'rgba(153, 102, 255, 0.7)',
                                'rgba(255, 159, 64, 0.7)'
                            ],
                            borderColor: [
                                'rgba(255, 255, 255, 1)'
                            ],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            title: {
                                display: false
                            }
                        }
                    }
                });
            }
            
            // --- INICIALIZAÇÃO ---
            setCurrentDate();
            carregarProdutos();
            carregarCategorias();
            carregarHistoricoVendas();
            atualizarDashboard();
        });
    </script>
</body>
</html>