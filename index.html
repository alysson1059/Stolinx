<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stolinx - Gerenciador de Estoque</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Sharp" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root{--color-primary:#7380ec;--color-danger:#ff7782;--color-success:#41f1b6;--color-warning:#ffbb55;--color-white:#fff;--color-info-dark:#7d8da1;--color-info-light:#dce1eb;--color-dark:#363949;--color-light:rgba(132,139,200,0.18);--color-primary-variant:#111e88;--color-dark-variant:#677483;--color-background:#f6f6f9;--card-border-radius:2rem;--border-radius-1:0.4rem;--border-radius-2:0.8rem;--border-radius-3:1.2rem;--card-padding:1.8rem;--padding-1:1.2rem;--box-shadow:0 2rem 3rem var(--color-light)}.dark-theme{--color-background:#181a1e;--color-white:#202528;--color-dark:#edeffd;--color-dark-variant:#a3a6ad;--color-light:rgba(0,0,0,0.4);--box-shadow:0 2rem 3rem var(--color-light);--color-info-light:#484d52}*{margin:0;padding:0;outline:0;appearance:none;border:0;text-decoration:none;list-style:none;box-sizing:border-box}html{font-size:14px}body{width:100vw;min-height:100vh;font-family:'Poppins',sans-serif;font-size:.88rem;background:var(--color-background);user-select:none;overflow-x:hidden;color:var(--color-dark);transition:background-color .3s ease,color .3s ease}.app-container{display:grid;width:96%;margin:0 auto;gap:1.8rem;grid-template-columns:14rem auto}a{color:var(--color-dark)}h1{font-weight:800;font-size:1.8rem}h2{font-size:1.4rem}h3{font-size:.87rem}aside{height:100vh;background:var(--color-white);transition:background-color .3s ease,color .3s ease}aside .top{display:flex;align-items:center;justify-content:space-between;margin-top:1.4rem}aside .logo{display:flex;gap:.8rem;margin-left:.8rem}aside .logo h2{font-weight:800}aside .logo h2 .danger{color:var(--color-danger)}aside .close{display:none}aside .sidebar{display:flex;flex-direction:column;height:86vh;position:relative;top:3rem}aside h3{font-weight:500}aside .sidebar a{display:flex;color:var(--color-info-dark);margin-left:2rem;gap:1rem;align-items:center;position:relative;height:3.7rem;transition:all 300ms ease;cursor:pointer}aside .sidebar a span{font-size:1.6rem;transition:all 300ms ease}aside .sidebar a:last-child{position:absolute;bottom:2rem;width:100%}aside .sidebar a.active{background:var(--color-light);color:var(--color-primary);margin-left:0}aside .sidebar a.active:before{content:'';width:6px;height:100%;background:var(--color-primary)}aside .sidebar a.active span{color:var(--color-primary)}aside .sidebar a:hover{color:var(--color-primary)}aside .sidebar a:hover span{margin-left:1rem}#theme-toggler-link.active{background:none}main{margin-top:1.4rem}.top-bar{display:none}.main-content{display:none}.main-content.active{display:block}main .date{display:inline-block;background:var(--color-light);border-radius:var(--border-radius-1);margin-top:1rem;padding:.5rem 1.6rem}main .insights{display:grid;grid-template-columns:repeat(3,1fr);gap:1.6rem}main .insights>div{background:var(--color-white);padding:var(--card-padding);border-radius:var(--card-border-radius);margin-top:1rem;box-shadow:var(--box-shadow);transition:all 300ms ease,background-color .3s ease}.card{background:var(--color-white);padding:var(--card-padding);border-radius:var(--card-border-radius);box-shadow:var(--box-shadow);transition:all 300ms ease,background-color .3s ease,color .3s ease;margin-top:1.5rem}.card h2{margin-bottom:1.2rem}table{width:100%;border-collapse:collapse;white-space:nowrap}.table-wrapper{overflow-x:auto}th,td{padding:15px;text-align:left;border-bottom:1px solid var(--color-info-light);transition:border-color .3s ease}.dashboard-grid{display:grid;grid-template-columns:1fr 1fr;gap:1.6rem;align-items:start}.dashboard-grid .card{margin-top:0}.chart-container{position:relative;height:300px;width:100%}.form-container{display:grid;grid-template-columns:1fr 1fr;gap:1.5rem}.input-group{display:flex;flex-direction:column;gap:.5rem}input,select{width:100%;padding:10px;border-radius:var(--border-radius-1);background:var(--color-info-light);font-family:'Poppins',sans-serif;color:var(--color-dark);font-size:.88rem;transition:background-color .3s ease,color .3s ease}button{padding:10px 20px;border-radius:var(--border-radius-1);background:var(--color-primary);color:#fff;cursor:pointer;transition:all 300ms ease;font-family:'Poppins',sans-serif;font-size:.9rem;width:100%}.btn-success{background:var(--color-success)}.btn-danger{background:var(--color-danger)}.btn-warning{background:var(--color-warning)}.modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.6);display:none;align-items:center;justify-content:center;z-index:1000}.modal-container{background:var(--color-white);padding:var(--card-padding);border-radius:var(--card-border-radius);width:90%;max-width:500px;box-shadow:0 5px 15px rgba(0,0,0,.3);transition:background-color .3s ease,color .3s ease}
        #login-container{display:flex;align-items:center;justify-content:center;width:100vw;height:100vh;flex-direction:column}.login-box{width:90%;max-width:400px;padding:2rem}.login-box h1{text-align:center;margin-bottom:1.5rem}.login-box .input-group{margin-bottom:1rem}.login-box .button-group{display:flex;gap:1rem;margin-top:1.5rem}.login-separator{display:flex;align-items:center;text-align:center;color:var(--color-info-dark);margin:1.5rem 0}.login-separator::before,.login-separator::after{content:'';flex:1;border-bottom:1px solid var(--color-info-light)}.login-separator:not(:empty)::before{margin-right:.25em}.login-separator:not(:empty)::after{margin-left:.25em}#google-login-btn{background:#fff;color:#444;display:flex;align-items:center;justify-content:center;gap:.75rem;box-shadow:0 2px 4px rgba(0,0,0,.1)}#google-login-btn img{width:18px;height:18px}
        @media screen and (max-width: 1200px){.app-container{width:94%;grid-template-columns:7rem auto}aside .logo h2{display:none}aside .sidebar h3{display:none}aside .sidebar a{width:5.6rem}aside .sidebar a:last-child{position:relative;margin-top:1.8rem}main .insights,.dashboard-grid{grid-template-columns:1fr}}
        @media screen and (max-width: 768px){:root{--card-padding:1.2rem}.app-container{width:100%;grid-template-columns:1fr;padding:0 1rem}aside{position:fixed;left:-100%;background:var(--color-white);width:18rem;z-index:3;box-shadow:1rem 3rem 4rem var(--color-light);height:100vh;padding-right:var(--card-padding);display:block;transition:left 400ms ease}aside.show-sidebar{left:0}aside .logo{margin-left:1rem}aside .logo h2{display:inline}aside .sidebar h3{display:inline}aside .sidebar a{width:100%;height:3.4rem}aside .sidebar a:last-child{position:absolute;bottom:5rem}aside .close{display:inline-block;cursor:pointer}main{margin-top:0;padding:0 1rem}.top-bar{display:flex;align-items:center;justify-content:space-between;margin:1.4rem 0 1rem 0}#menu-btn{display:inline-block}#mobile-page-title{display:inline-block}.main-content>h1{display:none}.form-container{grid-template-columns:1fr}}
    </style>
</head>
<body>

    <div id="login-container">
        <div class="card login-box">
            <h1>STOL<span class="danger">INX</span></h1>
            <div class="input-group">
                <label for="email">Email</label>
                <input type="email" id="email" placeholder="seu@email.com" required>
            </div>
            <div class="input-group">
                <label for="password">Senha</label>
                <input type="password" id="password" placeholder="******" required>
            </div>
            <div class="button-group">
                <button id="login-btn">Entrar</button>
                <button id="signup-btn" class="btn-success">Cadastrar</button>
            </div>
            <div class="login-separator">ou</div>
            <button id="google-login-btn">
                <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/c/c1/Google_%22G%22_logo.svg/768px-Google_%22G%22_logo.svg.png" alt="Google logo">
                <span>Entrar com Google</span>
            </button>
        </div>
    </div>
    
    <div class="app-container" style="display: none;">
        <aside>
            <div class="top"><div class="logo"><h2>STOL<span class="danger">INX</span></h2></div><div class="close" id="close-btn"><span class="material-icons-sharp">close</span></div></div>
            <div class="sidebar">
                <a class="nav-link active" data-target="dashboard"><span class="material-icons-sharp">grid_view</span><h3>Dashboard</h3></a>
                <a class="nav-link" data-target="estoque"><span class="material-icons-sharp">inventory_2</span><h3>Estoque</h3></a>
                <a class="nav-link" data-target="vendas"><span class="material-icons-sharp">receipt_long</span><h3>Vendas</h3></a>
                <a id="theme-toggler-link"><span class="material-icons-sharp">light_mode</span><h3>Tema</h3></a>
                <a href="#" id="logout-btn"><span class="material-icons-sharp">logout</span><h3>Sair</h3></a>
            </div>
        </aside>

        <main>
            <div class="top-bar"><div class="top-bar-left"><button id="menu-btn"><span class="material-icons-sharp">menu</span></button><h1 id="mobile-page-title">Dashboard</h1></div></div>
            <div id="dashboard" class="main-content active"><h1>Dashboard</h1><div class="date" id="current-date"></div><div class="insights"><div class="sales"><span class="material-icons-sharp">analytics</span><div class="middle"><div><h3>Faturamento do Mês</h3><h1 id="faturamento-mes">R$ 0,00</h1></div></div><small class="text-muted"></small></div><div class="expenses"><span class="material-icons-sharp">bar_chart</span><div class="middle"><div><h3>Investimento (Custo Total)</h3><h1 id="investimento-mes">R$ 0,00</h1></div></div><small class="text-muted"></small></div><div class="income"><span class="material-icons-sharp">stacked_line_chart</span><div class="middle"><div><h3>Lucro Potencial</h3><h1 id="lucro-mes">R$ 0,00</h1></div></div><small class="text-muted"></small></div></div><div class="dashboard-grid" style="margin-top:1.5rem"><div class="card"><h2>Vendas por Produto (Unidades no Mês)</h2><div class="chart-container"><canvas id="salesChart"></canvas></div></div><div class="card"><h2>Produtos com Mais Saída</h2><div class="table-wrapper"><table><thead><tr><th>Produto</th><th>Unidades Vendidas</th></tr></thead><tbody id="produtos-mais-saida-body"></tbody></table></div></div></div></div>
            <div id="estoque" class="main-content"><h1>Gerenciar Estoque</h1><div class="card"><form class="form-container" id="form-cadastro-produto"><input type="hidden" id="editProductId"><div class="input-group"><label for="codigoProduto">Código</label><input type="text" id="codigoProduto" required></div><div class="input-group"><label for="nomeProduto">Produto</label><input type="text" id="nomeProduto" required></div><div class="input-group"><label for="validade">Validade</label><input type="date" id="validade"></div><div class="input-group"><label for="quantidade">Qtd.</label><input type="number" id="quantidade" required></div><div class="input-group"><label for="custoProduto">Custo</label><input type="text" class="currency" id="custoProduto" required></div><div class="input-group"><label for="valorVenda">Venda</label><input type="text" class="currency" id="valorVenda" required></div><div class="input-group"><label for="categoria">Categoria</label><div style="display:flex;gap:10px"><select id="categoria" style="flex-grow:1"></select><button type="button" id="open-category-modal" class="btn-warning" style="width:auto;padding:0 15px"><span class="material-icons-sharp">settings</span></button></div></div><div class="input-group" style="justify-content:flex-end"><button type="submit" class="btn-success">Cadastrar</button></div></form></div><div class="card"><h2>Itens em Estoque</h2><input type="text" class="search-bar" id="searchEstoque" placeholder="Pesquisar..."><div class="table-wrapper"><table><thead><tr><th>Código</th><th>Produto</th><th>Qtd.</th><th>Custo</th><th>Venda</th><th>Lucro/Un.</th><th>Ações</th></tr></thead><tbody id="tabela-estoque-body"></tbody></table></div></div></div>
            <div id="vendas" class="main-content"><h1>Registrar Venda</h1><div class="card"><h2>Itens e Cliente</h2><div class="form-container"><div class="input-group" style="grid-column:1/-1"><label for="nomeCliente">Cliente</label><input type="text" id="nomeCliente"></div><div class="input-group"><label for="selectProdutoVenda">Produto</label><select id="selectProdutoVenda"></select></div><div class="input-group"><label for="quantidadeVenda">Qtd.</label><input type="number" id="quantidadeVenda" value="1" min="1"></div><div class="input-group" style="grid-column:1/-1"><button type="button" id="addItemOrcamento" style="width:auto;padding:10px 30px">Adicionar</button></div></div><h2 style="margin-top:2rem">Orçamento Atual</h2><div class="table-wrapper"><table><thead><tr><th>Produto</th><th>Qtd.</th><th>Preço Unit.</th><th>Subtotal</th><th>Ação</th></tr></thead><tbody id="orcamento-body"></tbody></table></div><div style="text-align:right;margin-top:1.5rem"><h3>Subtotal: <span id="subtotal-venda">R$ 0,00</span></h3><div style="display:inline-flex;align-items:center;gap:10px;margin-top:1rem"><label for="descontoVenda">Desconto (R$):</label><input type="text" class="currency" id="descontoVenda" style="width:150px"></div><h1 style="margin-top:1rem">Total: <span id="total-venda">R$ 0,00</span></h1></div></div><div class="card"><h2>Finalizar</h2><div class="form-container"><div class="input-group"><label for="dataVenda">Data</label><input type="text" id="dataVenda" readonly></div><div class="input-group"><label>Ações</label><div style="display:flex;gap:1rem;flex-wrap:wrap"><button type="button" id="share-whatsapp" style="background-color:#25d366;display:flex;align-items:center;justify-content:center;gap:.5rem"><span class="material-icons-sharp">share</span> WhatsApp</button><button type="button" id="registrar-venda-btn" class="btn-success" style="display:flex;align-items:center;justify-content:center;gap:.5rem"><span class="material-icons-sharp">check_circle</span> Registrar Venda</button></div></div></div></div><div class="card"><h2>Histórico de Vendas</h2><input type="text" class="search-bar" id="pesquisa-venda-cliente" placeholder="Pesquisar por cliente..."><div class="table-wrapper"><table><thead><tr><th>Cliente</th><th>Data</th><th>Itens</th><th>Total</th></tr></thead><tbody id="historico-vendas-body"></tbody></table></div></div></div>
        </main>
    </div>

    <div class="modal-overlay" id="category-modal"><div class="modal-container"><div class="modal-header"><h2>Gerenciar Categorias</h2><button class="close-modal" id="close-category-modal"><span class="material-icons-sharp">close</span></button></div><div class="modal-body"><div class="input-group"><label for="nova-categoria-nome">Nova Categoria</label><div style="display:flex;gap:10px"><input type="text" id="nova-categoria-nome" placeholder="Nome"><button id="add-categoria-btn" class="btn-success" style="width:auto">Adicionar</button></div></div><h3 style="margin-top:2rem;margin-bottom:1rem">Categorias Existentes</h3><ul id="lista-categorias"></ul></div></div></div>

    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
    
    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAv54tgJ5oYrwTSNXpB2rCGjNbhJhe2CoM",
            authDomain: "stolinx-d6e26.firebaseapp.com",
            projectId: "stolinx-d6e26",
            storageBucket: "stolinx-d6e26.appspot.com",
            messagingSenderId: "715535971682",
            appId: "1:715535971682:web:66620d1590ae3e4ba6a83b"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        let currentUserId = null;

        const loginContainer = document.getElementById('login-container');
        const appContainer = document.querySelector('.app-container');
        const emailInput = document.getElementById('email');
        const passwordInput = document.getElementById('password');

        // --- CONTROLE DE AUTENTICAÇÃO ---
        auth.onAuthStateChanged(user => {
            if (user) {
                currentUserId = user.uid;
                loginContainer.style.display = 'none';
                appContainer.style.display = 'grid';
                initializeAppFunctions();
            } else {
                currentUserId = null;
                loginContainer.style.display = 'flex';
                appContainer.style.display = 'none';
            }
        });

        document.getElementById('signup-btn').addEventListener('click', () => {
            const email = emailInput.value;
            const password = passwordInput.value;
            if (!email || !password) return alert("Por favor, preencha email e senha.");
            auth.createUserWithEmailAndPassword(email, password).catch(error => alert(`Erro ao cadastrar: ${error.message}`));
        });

        document.getElementById('login-btn').addEventListener('click', () => {
            const email = emailInput.value;
            const password = passwordInput.value;
            if (!email || !password) return alert("Por favor, preencha email e senha.");
            auth.signInWithEmailAndPassword(email, password).catch(error => alert(`Erro ao entrar: ${error.message}`));
        });
        
        document.getElementById('google-login-btn').addEventListener('click', () => {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider).catch(error => alert(`Erro com Google: ${error.message}`));
        });

        document.getElementById('logout-btn').addEventListener('click', (e) => {
            e.preventDefault();
            auth.signOut();
        });
        
        // --- FUNÇÕES PRINCIPAIS DO APP (SÓ RODAM APÓS LOGIN) ---
        let appInitialized = false;
        function initializeAppFunctions() {
            if (appInitialized) return; // Garante que a inicialização só ocorra uma vez

            const menuBtn = document.getElementById('menu-btn');
            const closeBtn = document.getElementById('close-btn');
            const aside = document.querySelector('aside');
            const themeTogglerLink = document.getElementById('theme-toggler-link');

            if(menuBtn) menuBtn.addEventListener('click', () => aside.classList.add('show-sidebar'));
            if(closeBtn) closeBtn.addEventListener('click', () => aside.classList.remove('show-sidebar'));
            
            if(themeTogglerLink){
                themeTogglerLink.addEventListener('click', (e) => {
                    e.preventDefault();
                    document.body.classList.toggle('dark-theme');
                    const isDark = document.body.classList.contains('dark-theme');
                    themeTogglerLink.querySelector('span').textContent = isDark ? 'dark_mode' : 'light_mode';
                    localStorage.setItem('darkMode', isDark ? 'enabled' : 'disabled');
                });
                if (localStorage.getItem('darkMode') === 'enabled') {
                    document.body.classList.add('dark-theme');
                    themeTogglerLink.querySelector('span').textContent = 'dark_mode';
                }
            }
            
            const navLinks = document.querySelectorAll('.nav-link');
            const contentSections = document.querySelectorAll('.main-content');
            const mobilePageTitle = document.getElementById('mobile-page-title');

            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetId = link.getAttribute('data-target');
                    if (!targetId) return;
                    navLinks.forEach(l => l.classList.remove('active'));
                    contentSections.forEach(s => s.classList.remove('active'));
                    link.classList.add('active');
                    document.getElementById(targetId).classList.add('active');
                    if(mobilePageTitle && link.querySelector('h3')) mobilePageTitle.textContent = link.querySelector('h3').textContent;
                    if(aside) aside.classList.remove('show-sidebar');
                });
            });

            function setCurrentDate() {
                const today = new Date();
                const options = { year: 'numeric', month: 'long', day: 'numeric' };
                document.getElementById('current-date').textContent = today.toLocaleDateString('pt-BR', options);
                document.getElementById('dataVenda').value = today.toLocaleDateString('pt-BR');
            }

            function formatCurrency(input) {
                let value = input.value.replace(/\D/g, '');
                if (value === "") { input.value = ""; return; }
                input.value = (parseInt(value, 10) / 100).toLocaleString('pt-BR', { minimumFractionDigits: 2 });
            }
            
            document.querySelectorAll('.currency').forEach(input => input.addEventListener('input', () => formatCurrency(input)));
            
            const categoryModal = document.getElementById('category-modal');
            const openModalBtn = document.getElementById('open-category-modal');
            const closeModalBtn = document.getElementById('close-category-modal');
            const addCategoriaBtn = document.getElementById('add-categoria-btn');

            openModalBtn.addEventListener('click', () => categoryModal.style.display = 'flex');
            closeModalBtn.addEventListener('click', () => categoryModal.style.display = 'none');
            categoryModal.addEventListener('click', (e) => { if (e.target === categoryModal) { categoryModal.style.display = 'none'; } });

            addCategoriaBtn.addEventListener('click', () => {
                const nomeInput = document.getElementById('nova-categoria-nome');
                const nomeCategoria = nomeInput.value.trim();
                if (!nomeCategoria) return alert('Digite um nome para a categoria.');
                db.collection("categorias").add({ nome: nomeCategoria, userId: currentUserId }).then(() => { nomeInput.value = ""; });
            });

            const formCadastro = document.getElementById('form-cadastro-produto');
            formCadastro.addEventListener('submit', (e) => {
                e.preventDefault();
                const produto = {
                    codigo: formCadastro.codigoProduto.value,
                    nome: formCadastro.nomeProduto.value,
                    quantidade: parseInt(formCadastro.quantidade.value),
                    custo: parseFloat(formCadastro.custoProduto.value.replace(/\./g, '').replace(',', '.')),
                    valorVenda: parseFloat(formCadastro.valorVenda.value.replace(/\./g, '').replace(',', '.')),
                    categoria: formCadastro.categoria.value,
                    userId: currentUserId
                };
                produto.lucroUnidade = produto.valorVenda - produto.custo;
                db.collection("produtos").add(produto).then(() => { alert("Produto cadastrado!"); formCadastro.reset(); });
            });
            
            function carregarCategorias() {
                const selectCategoria = document.getElementById('categoria');
                const listaCategoriasUl = document.getElementById('lista-categorias');
                db.collection("categorias").where("userId", "==", currentUserId).orderBy("nome").onSnapshot(snapshot => {
                    selectCategoria.innerHTML = ""; listaCategoriasUl.innerHTML = "";
                    if (snapshot.empty) { selectCategoria.innerHTML = '<option>Nenhuma categoria</option>'; listaCategoriasUl.innerHTML = '<li>Nenhuma categoria.</li>'; return; }
                    snapshot.forEach(doc => {
                        const categoria = doc.data();
                        const option = document.createElement('option');
                        option.value = categoria.nome; option.textContent = categoria.nome;
                        selectCategoria.appendChild(option);
                        const li = document.createElement('li');
                        li.innerHTML = `<span>${categoria.nome}</span><div class="action-buttons"><button class="btn-danger" onclick="window.excluirCategoria('${doc.id}')"><span class="material-icons-sharp">delete</span></button></div>`;
                        listaCategoriasUl.appendChild(li);
                    });
                });
            }
            
            window.excluirCategoria = (id) => { if (confirm(`Tem certeza?`)) { db.collection("categorias").doc(id).delete(); } }

            function carregarProdutos() {
                const tabelaCorpo = document.getElementById("tabela-estoque-body");
                const selectVenda = document.getElementById('selectProdutoVenda');
                db.collection("produtos").where("userId", "==", currentUserId).orderBy("nome").onSnapshot((snapshot) => {
                    tabelaCorpo.innerHTML = ''; selectVenda.innerHTML = '<option value="">Selecione um item</option>';
                    if (snapshot.empty) { tabelaCorpo.innerHTML = '<tr><td colspan="7">Nenhum produto.</td></tr>'; return; }
                    snapshot.forEach((doc) => {
                        const produto = doc.data();
                        const lucroUnidade = produto.lucroUnidade || 0;
                        const tr = document.createElement('tr');
                        tr.innerHTML = `<td>${produto.codigo}</td><td>${produto.nome}</td><td class="${produto.quantidade < 3 ? 'low-stock-warning' : ''}">${produto.quantidade}</td><td>R$ ${produto.custo.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td><td>R$ ${produto.valorVenda.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td><td>R$ ${lucroUnidade.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td><td class="action-buttons"><button class="btn-warning"><span class="material-icons-sharp">edit</span></button><button class="btn-danger" onclick="window.excluirProduto('${doc.id}')"><span class="material-icons-sharp">delete</span></button></td>`;
                        tabelaCorpo.appendChild(tr);
                        if (produto.quantidade > 0) {
                            const option = document.createElement('option');
                            option.value = doc.id; option.textContent = `${produto.nome} (Qtd: ${produto.quantidade})`;
                            option.dataset.price = produto.valorVenda; option.dataset.name = produto.nome;
                            selectVenda.appendChild(option);
                        }
                    });
                });
            }

            window.excluirProduto = (id) => { if (confirm(`Tem certeza?`)) { db.collection("produtos").doc(id).delete(); } }

            let orcamento = [];
            const btnRegistrarVenda = document.getElementById('registrar-venda-btn');
            document.getElementById('addItemOrcamento').addEventListener('click', () => {
                const select = document.getElementById('selectProdutoVenda');
                if (!select.value) return;
                const opt = select.options[select.selectedIndex];
                orcamento.push({ id: select.value, nome: opt.dataset.name, preco: parseFloat(opt.dataset.price), qtd: parseInt(document.getElementById('quantidadeVenda').value) });
                atualizarTabelaOrcamento();
            });
            
            function atualizarTabelaOrcamento() {
                const orcamentoBody = document.getElementById('orcamento-body');
                orcamentoBody.innerHTML = ''; let subtotal = 0;
                orcamento.forEach((item, index) => {
                    const itemSubtotal = item.qtd * item.preco; subtotal += itemSubtotal;
                    const tr = document.createElement('tr');
                    tr.innerHTML = `<td>${item.nome}</td><td>${item.qtd}</td><td>R$ ${item.preco.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td><td>R$ ${itemSubtotal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td><td class="action-buttons"><button class="btn-danger" onclick="window.removerItemOrcamento(${index})"><span class="material-icons-sharp">close</span></button></td>`;
                    orcamentoBody.appendChild(tr);
                });
                const desconto = parseFloat(document.getElementById('descontoVenda').value.replace(/\./g, '').replace(',', '.')) || 0;
                const total = subtotal - desconto;
                document.getElementById('subtotal-venda').textContent = `R$ ${subtotal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                document.getElementById('total-venda').textContent = `R$ ${total.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            }

            window.removerItemOrcamento = (index) => { orcamento.splice(index, 1); atualizarTabelaOrcamento(); }
            document.getElementById('descontoVenda').addEventListener('input', atualizarTabelaOrcamento);
            document.getElementById('share-whatsapp').addEventListener('click', () => {
                if (orcamento.length === 0) return alert('Adicione itens ao orçamento.');
                let cliente = document.getElementById('nomeCliente').value || 'Cliente', total = document.getElementById('total-venda').innerText;
                let texto = `*Orçamento para ${cliente}*\n\n`;
                orcamento.forEach(item => { texto += `- ${item.qtd}x ${item.nome}: R$ ${(item.qtd * item.preco).toLocaleString('pt-BR', {minimumFractionDigits: 2})}\n`; });
                texto += `\n*Total: ${total}*`;
                window.open(`https://wa.me/?text=${encodeURIComponent(texto)}`, '_blank');
            });

            btnRegistrarVenda.addEventListener('click', () => {
                if (orcamento.length === 0) return alert('Adicione itens para registrar a venda.');
                const venda = {
                    cliente: document.getElementById('nomeCliente').value || 'Não informado',
                    data: firebase.firestore.FieldValue.serverTimestamp(),
                    itens: orcamento,
                    total: parseFloat(document.getElementById('total-venda').textContent.replace('R$ ', '').replace(/\./g, '').replace(',', '.')),
                    userId: currentUserId
                };
                const batch = db.batch();
                batch.set(db.collection('vendas').doc(), venda);
                orcamento.forEach(item => {
                    batch.update(db.collection('produtos').doc(item.id), { quantidade: firebase.firestore.FieldValue.increment(-item.qtd) });
                });
                batch.commit().then(() => {
                    alert('Venda registrada com sucesso!');
                    orcamento = [];
                    document.getElementById('nomeCliente').value = '';
                    document.getElementById('descontoVenda').value = '';
                    atualizarTabelaOrcamento();
                });
            });

            let todasAsVendas = [];
            function carregarHistoricoVendas() {
                db.collection('vendas').where("userId", "==", currentUserId).onSnapshot(snapshot => {
                    todasAsVendas = [];
                    snapshot.forEach(doc => todasAsVendas.push(doc.data()));
                    todasAsVendas.sort((a, b) => (b.data ? b.data.toMillis() : 0) - (a.data ? a.data.toMillis() : 0));
                    renderizarVendas(todasAsVendas);
                });
            }

            function renderizarVendas(vendas) {
                const tabelaCorpo = document.getElementById('historico-vendas-body');
                tabelaCorpo.innerHTML = '';
                if (vendas.length === 0) { tabelaCorpo.innerHTML = '<tr><td colspan="4">Nenhuma venda encontrada.</td></tr>'; return; }
                vendas.forEach(venda => {
                    const tr = document.createElement('tr');
                    const dataF = venda.data ? venda.data.toDate().toLocaleDateString('pt-BR') : '';
                    const itensF = venda.itens.map(i => `${i.qtd}x ${i.nome}`).join(', ');
                    tr.innerHTML = `<td>${venda.cliente}</td><td>${dataF}</td><td>${itensF}</td><td>R$ ${venda.total.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>`;
                    tabelaCorpo.appendChild(tr);
                });
            }
            
            document.getElementById('pesquisa-venda-cliente').addEventListener('input', (e) => {
                const termo = e.target.value.toLowerCase();
                const filtradas = todasAsVendas.filter(v => v.cliente.toLowerCase().includes(termo));
                renderizarVendas(termo ? filtradas : todasAsVendas);
            });

            let salesChartInstance;
            function atualizarDashboard() {
                db.collection('produtos').where("userId", "==", currentUserId).onSnapshot(s => {
                    let inv = 0, lucro = 0;
                    s.forEach(doc => { const p = doc.data(); inv += p.custo * p.quantidade; lucro += (p.valorVenda - p.custo) * p.quantidade; });
                    document.getElementById('investimento-mes').textContent = `R$ ${inv.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                    document.getElementById('lucro-mes').textContent = `R$ ${lucro.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                });

                db.collection('vendas').where("userId", "==", currentUserId).onSnapshot(s => {
                    let fat = 0; const hoje = new Date(), mes = hoje.getMonth(), ano = hoje.getFullYear(); const top = {};
                    s.forEach(doc => {
                        const v = doc.data();
                        if (v.data) {
                            const dataVenda = v.data.toDate();
                            if (dataVenda.getMonth() === mes && dataVenda.getFullYear() === ano) {
                                fat += v.total;
                                v.itens.forEach(i => { top[i.nome] = (top[i.nome] || 0) + i.qtd; });
                            }
                        }
                    });
                    document.getElementById('faturamento-mes').textContent = `R$ ${fat.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                    const sortedTop = Object.entries(top).sort((a, b) => b[1] - a[1]);
                    const topBody = document.getElementById('produtos-mais-saida-body');
                    topBody.innerHTML = '';
                    if (sortedTop.length === 0) { topBody.innerHTML = '<tr><td colspan="2">Nenhuma venda este mês.</td></tr>';
                    } else { sortedTop.slice(0, 5).forEach(([n, q]) => { const tr = document.createElement('tr'); tr.innerHTML = `<td>${n}</td><td>${q}</td>`; topBody.appendChild(tr); }); }
                    renderProductPieChart(sortedTop);
                });
            }
            
            function renderProductPieChart(data) {
                const ctx = document.getElementById('salesChart').getContext('2d');
                if (salesChartInstance) salesChartInstance.destroy();
                salesChartInstance = new Chart(ctx, {
                    type: 'pie', data: { labels: data.map(i => i[0]), datasets: [{ label: 'Unidades', data: data.map(i => i[1]), backgroundColor: ['#FF6384', '#36A2EB', '#FFCE56', '#4BC0C0', '#9966FF', '#FF9F40'] }] },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            }
            
            setCurrentDate();
            appInitialized = true; // Marca que o app foi inicializado
        }
    </script>
</body>
</html>
