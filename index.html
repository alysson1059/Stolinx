<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stolinx - Gerenciador de Estoque</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Sharp" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --color-primary: #7380ec;
            --color-danger: #ff7782;
            --color-success: #41f1b6;
            --color-warning: #ffbb55;
            --color-white: #fff;
            --color-info-dark: #7d8da1;
            --color-info-light: #dce1eb;
            --color-dark: #363949;
            --color-light: rgba(132, 139, 200, 0.18);
            --color-primary-variant: #111e88;
            --color-dark-variant: #677483;
            --color-background: #f6f6f9;

            --card-border-radius: 2rem;
            --border-radius-1: 0.4rem;
            --border-radius-2: 0.8rem;
            --border-radius-3: 1.2rem;

            --card-padding: 1.8rem;
            --padding-1: 1.2rem;

            --box-shadow: 0 2rem 3rem var(--color-light);
        }

        .dark-theme {
            --color-background: #181a1e;
            --color-white: #202528;
            --color-dark: #edeffd;
            --color-dark-variant: #a3a6ad;
            --color-light: rgba(0, 0, 0, 0.4);
            --box-shadow: 0 2rem 3rem var(--color-light);
            --color-info-light: #484d52;
        }

        * {
            margin: 0;
            padding: 0;
            outline: 0;
            appearance: none;
            border: 0;
            text-decoration: none;
            list-style: none;
            box-sizing: border-box;
        }

        html {
            font-size: 14px;
        }

        body {
            width: 100vw;
            height: 100vh;
            font-family: 'Poppins', sans-serif;
            font-size: 0.88rem;
            background: var(--color-background);
            user-select: none;
            overflow-x: hidden;
            color: var(--color-dark);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* --- AUTHENTICATION STYLES --- */
        #auth-container {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
            height: 100vh;
            padding: 1rem;
        }

        .auth-form-wrapper {
            width: 100%;
            max-width: 400px;
            background: var(--color-white);
            padding: var(--card-padding);
            border-radius: var(--card-border-radius);
            box-shadow: var(--box-shadow);
            transition: all 300ms ease;
        }
        
        .auth-form-wrapper:hover {
             box-shadow: none;
        }

        .auth-form-wrapper h1 {
            text-align: center;
            margin-bottom: 0.5rem;
        }
        
        .auth-form-wrapper h1 .danger {
            color: var(--color-danger);
        }

        .auth-form-wrapper p {
            text-align: center;
            color: var(--color-info-dark);
            margin-bottom: 2rem;
        }
        
        .auth-form-wrapper .input-group {
            margin-bottom: 1.5rem;
        }

        .auth-form-wrapper input {
            width: 100%;
            padding: 12px;
            border-radius: var(--border-radius-2);
            background: var(--color-info-light);
            font-family: 'Poppins', sans-serif;
            color: var(--color-dark);
            font-size: 0.9rem;
            border: 2px solid transparent;
            transition: all 0.3s ease;
        }
        
        .auth-form-wrapper input:focus {
            border-color: var(--color-primary);
        }

        .auth-form-wrapper button {
            width: 100%;
            padding: 12px;
            border-radius: var(--border-radius-2);
            background: var(--color-primary);
            color: #fff;
            cursor: pointer;
            transition: all 300ms ease;
            font-family: 'Poppins', sans-serif;
            font-size: 1rem;
            font-weight: 500;
        }
        
        .auth-form-wrapper button:hover {
            opacity: 0.8;
        }
        
        .google-btn {
            background: #db4437 !important;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            margin-top: 1rem;
        }
        
        .auth-toggle-link {
            display: block;
            text-align: center;
            margin-top: 1.5rem;
            color: var(--color-primary);
            cursor: pointer;
        }
        
        #auth-message {
            text-align: center;
            padding: 10px;
            border-radius: var(--border-radius-1);
            margin-bottom: 1rem;
            display: none;
            font-weight: 500;
        }
        
        #auth-message.success {
            background-color: var(--color-success);
            color: #fff;
        }
        
        #auth-message.error {
            background-color: var(--color-danger);
            color: #fff;
        }

        #register-form {
            display: none;
        }
        
        /* --- MAIN APP STYLES --- */
        .container {
            display: none; /* Hidden by default */
            width: 96%;
            margin: 0 auto;
            gap: 1.8rem;
            grid-template-columns: 14rem auto;
        }
        
        .container.visible {
            display: grid;
        }

        a {
            color: var(--color-dark);
        }

        h1 {
            font-weight: 800;
            font-size: 1.8rem;
        }

        h2 {
            font-size: 1.4rem;
        }
        
        h3 {
            font-size: 0.87rem;
        }

        aside {
            height: 100vh;
            background: var(--color-white);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        aside .top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 1.4rem;
        }

        aside .logo {
            display: flex;
            gap: 0.8rem;
        }

        aside .logo h2 {
            font-weight: 800;
        }
        
        aside .logo h2 .danger {
            color: var(--color-danger);
        }
        
        aside .close {
            display: none;
        }

        aside .sidebar {
            display: flex;
            flex-direction: column;
            height: 86vh;
            position: relative;
            top: 3rem;
        }

        aside h3 {
            font-weight: 500;
        }

        aside .sidebar a {
            display: flex;
            color: var(--color-info-dark);
            margin-left: 2rem;
            gap: 1rem;
            align-items: center;
            position: relative;
            height: 3.7rem;
            transition: all 300ms ease;
            cursor: pointer;
        }

        aside .sidebar a span {
            font-size: 1.6rem;
            transition: all 300ms ease;
        }
        
        aside .sidebar a:last-child {
            position: absolute;
            bottom: 2rem;
            width: 100%;
        }

        aside .sidebar a.active {
            background: var(--color-light);
            color: var(--color-primary);
            margin-left: 0;
        }

        aside .sidebar a.active:before {
            content: '';
            width: 6px;
            height: 100%;
            background: var(--color-primary);
        }
        
        aside .sidebar a.active span {
            color: var(--color-primary);
        }

        aside .sidebar a:hover {
            color: var(--color-primary);
        }

        aside .sidebar a:hover span {
            margin-left: 1rem;
        }
        
        #theme-toggler-link.active {
            background: none;
        }
        
        main {
            margin-top: 1.4rem;
        }

        .top-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1rem;
        }

        .top-bar-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        #menu-btn {
            display: none;
            background: none;
            color: var(--color-dark);
            font-size: 1.8rem;
            cursor: pointer;
        }

        #mobile-page-title {
            display: none;
        }
        
        .main-content {
            display: none;
        }

        .main-content.active {
            display: block;
        }
        
        main .date {
            display: inline-block;
            background: var(--color-light);
            border-radius: var(--border-radius-1);
            margin-top: 1rem;
            padding: 0.5rem 1.6rem;
        }
        
        main .insights {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 1.6rem;
        }
        
        main .insights > div {
            background: var(--color-white);
            padding: var(--card-padding);
            border-radius: var(--card-border-radius);
            margin-top: 1rem;
            box-shadow: var(--box-shadow);
            transition: all 300ms ease, background-color 0.3s ease;
        }

        main .insights > div:hover {
            box-shadow: none;
        }

        main .insights > div span {
            background: var(--color-primary);
            padding: 0.5rem;
            border-radius: 50%;
            color: #fff;
            font-size: 2rem;
        }

        main .insights > div.sales span { background: var(--color-success); }
        main .insights > div.expenses span { background: var(--color-danger); }
        main .insights > div.income span { background: var(--color-primary); }


        main .insights > div .middle {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        main .insights h3 {
            margin: 1rem 0 0.6rem;
            font-size: 1rem;
        }

        .text-muted {
            color: var(--color-info-dark);
        }
        
        .card {
            background: var(--color-white);
            padding: var(--card-padding);
            border-radius: var(--card-border-radius);
            box-shadow: var(--box-shadow);
            transition: all 300ms ease, background-color 0.3s ease, color 0.3s ease;
            margin-top: 1.5rem;
        }

        .card:hover {
            box-shadow: none;
        }
        
        .card h2 {
            margin-bottom: 1.2rem;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            white-space: nowrap; /* Prevent text wrapping in table cells */
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--color-info-light);
            transition: border-color 0.3s ease;
        }
        
        tbody tr:last-child td {
            border: none;
        }

        .table-wrapper {
            overflow-x: auto;
        }
        
        .low-stock-warning {
            color: var(--color-warning);
            font-weight: bold;
        }
        
        .vencimento-proximo {
            background-color: #fffbe6 !important;
        }
        .dark-theme .vencimento-proximo {
            background-color: #332c21 !important;
        }
        .vencimento-proximo td {
            color: #8a6d3b !important;
        }
        .dark-theme .vencimento-proximo td {
            color: #e4c489 !important;
        }
        .vencimento-aviso-icon {
            color: var(--color-warning);
            font-size: 1.2rem;
            vertical-align: middle;
            margin-left: 8px;
            cursor: help;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.6rem;
            align-items: start;
        }

        .dashboard-grid .card {
            margin-top: 0;
        }

        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        .form-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .input-group label {
            font-weight: 500;
        }

        input, select {
            width: 100%;
            padding: 10px;
            border-radius: var(--border-radius-1);
            background: var(--color-info-light);
            font-family: 'Poppins', sans-serif;
            color: var(--color-dark);
            font-size: 0.88rem;
            transition: background-color 0.3s ease, color 0.3s ease;
        }
        
        button {
            padding: 10px 20px;
            border-radius: var(--border-radius-1);
            background: var(--color-primary);
            color: #fff;
            cursor: pointer;
            transition: all 300ms ease;
            font-family: 'Poppins', sans-serif;
            font-size: 0.9rem;
            width: 100%;
        }
        
        button:hover {
            opacity: 0.8;
        }
        
        .btn-success { background: var(--color-success); }
        .btn-danger { background: var(--color-danger); }
        .btn-warning { background: var(--color-warning); }
        
        .action-buttons button {
            margin-right: 5px;
            padding: 5px 8px;
            width: auto;
        }

        .action-buttons .material-icons-sharp {
            font-size: 1.2rem;
            vertical-align: middle;
        }

        .search-bar {
            width: 100%;
            margin-bottom: 0.5rem;
        }

        .search-instruction {
            font-size: 0.75rem;
            color: var(--color-info-dark);
            margin-bottom: 1.5rem;
            display: block;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-container {
            background: var(--color-white);
            padding: var(--card-padding);
            border-radius: var(--card-border-radius);
            width: 90%;
            max-width: 500px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--color-info-light);
            padding-bottom: 1rem;
            margin-bottom: 1.5rem;
            transition: border-color 0.3s ease;
        }

        .modal-header h2 {
            margin: 0;
        }

        .modal-header .close-modal {
            background: none;
            color: var(--color-dark);
            font-size: 2rem;
            cursor: pointer;
            padding: 0;
            width: auto;
        }

        #lista-categorias li {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 5px;
            border-bottom: 1px solid var(--color-info-light);
            transition: border-color 0.3s ease, color 0.3s ease;
        }

        @media screen and (max-width: 1200px) {
            .container.visible {
                width: 94%;
                grid-template-columns: 7rem auto;
            }

            aside .logo h2 {
                display: none;
            }

            aside .sidebar h3 {
                display: none;
            }

            aside .sidebar a {
                width: 5.6rem;
            }
             aside .sidebar a:last-child {
                position: relative;
                margin-top: 1.8rem;
            }

            main .insights {
                grid-template-columns: 1fr;
            }
            .dashboard-grid {
                grid-template-columns: 1fr;
            }
        }

        @media screen and (max-width: 768px) {
            .container.visible {
                width: 100%;
                grid-template-columns: 1fr;
                padding: 0; /* Remove horizontal padding from container */
            }
            
            .card {
                padding: var(--padding-1);
            }

            aside {
                position: fixed;
                left: -100%;
                background: var(--color-white);
                width: 18rem;
                z-index: 3;
                box-shadow: 1rem 3rem 4rem var(--color-light);
                height: 100vh;
                padding-right: var(--card-padding);
                display: block;
                transition: left 400ms ease, background-color 0.3s ease;
            }

            aside.show-sidebar {
                left: 0;
            }

            aside .logo {
                margin-left: 1rem;
            }

             aside .logo h2 {
                display: inline;
            }

            aside .sidebar h3 {
                display: inline;
            }
            
            aside .sidebar a {
                width: 100%;
                height: 3.4rem;
            }

            aside .sidebar a:last-child {
                position: absolute;
                bottom: 5rem;
            }

            aside .close {
                display: inline-block;
                cursor: pointer;
            }

            main {
                margin-top: 0;
                padding: 0 1rem; /* Add padding to main content area */
            }
            
            .top-bar {
                margin-top: 1.4rem;
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                padding: 0 1rem;
                background: var(--color-background);
                z-index: 2;
                box-shadow: 0 1rem 1rem var(--color-light);
            }
            .dark-theme .top-bar {
                 box-shadow: 0 1rem 1rem var(--color-light);
            }

            main .main-content {
                padding-top: 5rem; /* Add padding to push content below fixed top-bar */
            }


            #menu-btn {
                display: inline-block;
            }
            #mobile-page-title {
                display: inline-block;
            }

            .main-content > h1 {
                display: none;
            }
            
            .form-container {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Authentication Container -->
    <div id="auth-container">
        <div class="auth-form-wrapper">
            <!-- Login Form -->
            <form id="login-form">
                <h1>STOL<span class="danger">INX</span></h1>
                <p>Faça login para gerenciar seu estoque.</p>
                <div id="auth-message"></div>
                <div class="input-group">
                    <input type="email" id="login-email" placeholder="Seu e-mail" required>
                </div>
                <div class="input-group">
                    <input type="password" id="login-password" placeholder="Sua senha" required>
                </div>
                <button type="submit">Entrar</button>
                <button type="button" class="google-btn" id="google-signin-btn">
                    <span class="material-icons-sharp">login</span> Entrar com Google
                </button>
                <a class="auth-toggle-link" id="show-register">Não tem uma conta? Cadastre-se</a>
            </form>

            <!-- Register Form -->
            <form id="register-form">
                <h1>STOL<span class="danger">INX</span></h1>
                <p>Crie sua conta gratuitamente.</p>
                <div class="input-group">
                    <input type="email" id="register-email" placeholder="Seu e-mail" required>
                </div>
                <div class="input-group">
                    <input type="password" id="register-password" placeholder="Crie uma senha" required>
                </div>
                <button type="submit">Cadastrar</button>
                <a class="auth-toggle-link" id="show-login">Já tem uma conta? Faça login</a>
            </form>
        </div>
    </div>

    <!-- Main App Container -->
    <div class="container">
        <aside>
            <div class="top">
                <div class="logo">
                    <h2>STOL<span class="danger">INX</span></h2>
                </div>
                <div class="close" id="close-btn">
                    <span class="material-icons-sharp">close</span>
                </div>
            </div>

            <div class="sidebar">
                <a href="#" class="nav-link active" data-target="dashboard">
                    <span class="material-icons-sharp">grid_view</span>
                    <h3>Dashboard</h3>
                </a>
                <a href="#" class="nav-link" data-target="estoque">
                    <span class="material-icons-sharp">inventory_2</span>
                    <h3>Estoque</h3>
                </a>
                <a href="#" class="nav-link" data-target="vendas">
                    <span class="material-icons-sharp">receipt_long</span>
                    <h3>Vendas</h3>
                </a>
                <a id="theme-toggler-link">
                    <span class="material-icons-sharp">light_mode</span>
                    <h3>Tema</h3>
                </a>
                <a href="#" id="logout-btn">
                    <span class="material-icons-sharp">logout</span>
                    <h3>Sair</h3>
                </a>
            </div>
        </aside>

        <main>
             <div class="top-bar">
                 <div class="top-bar-left">
                     <button id="menu-btn">
                         <span class="material-icons-sharp">menu</span>
                     </button>
                     <h1 id="mobile-page-title">Dashboard</h1>
                 </div>
             </div>

            <div id="dashboard" class="main-content active">
                <h1>Dashboard</h1>
                <div class="date" id="current-date">Carregando data...</div>

                <div class="insights">
                    <div class="sales">
                        <span class="material-icons-sharp">analytics</span>
                        <div class="middle">
                            <div>
                                <h3>Faturamento do Mês</h3>
                                <h1 id="faturamento-mes">R$ 0,00</h1>
                            </div>
                        </div>
                        <small class="text-muted">Aguardando vendas</small>
                    </div>
                    <div class="expenses">
                        <span class="material-icons-sharp">bar_chart</span>
                        <div class="middle">
                            <div>
                                <h3>Investimento (Custo Total)</h3>
                                <h1 id="investimento-mes">R$ 0,00</h1>
                            </div>
                        </div>
                        <small class="text-muted">Soma do custo do estoque</small>
                    </div>
                    <div class="income">
                        <span class="material-icons-sharp">stacked_line_chart</span>
                        <div class="middle">
                            <div>
                                <h3>Lucro Potencial</h3>
                                <h1 id="lucro-mes">R$ 0,00</h1>
                            </div>
                        </div>
                        <small class="text-muted">Total de venda - Custo total</small>
                    </div>
                </div>

                <div class="dashboard-grid" style="margin-top: 1.5rem;">
                    <div class="card">
                        <h2>Vendas por Produto (Unidades no Mês)</h2>
                        <div class="chart-container">
                            <canvas id="salesChart"></canvas>
                        </div>
                    </div>
                     <div class="card">
                        <h2>Produtos com Mais Saída</h2>
                        <div class="table-wrapper">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Produto</th>
                                        <th>Unidades Vendidas</th>
                                    </tr>
                                </thead>
                                <tbody id="produtos-mais-saida-body">
                                    <tr><td colspan="2">Nenhuma venda registrada ainda.</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>

            <div id="estoque" class="main-content">
                <h1>Gerenciar Estoque</h1>
                <div class="card">
                    <h2>Cadastrar Novo Item</h2>
                    <form class="form-container" id="form-cadastro-produto">
                        <input type="hidden" id="editProductId">
                        <div class="input-group">
                            <label for="codigoProduto">Código do Produto</label>
                            <input type="text" id="codigoProduto" placeholder="Ex: SB001" required>
                        </div>
                        <div class="input-group">
                            <label for="nomeProduto">Nome do Produto</label>
                            <input type="text" id="nomeProduto" placeholder="Ex: Sabonete Líquido" required>
                        </div>
                        <div class="input-group">
                            <label for="validade">Validade</label>
                            <input type="date" id="validade">
                        </div>
                        <div class="input-group">
                            <label for="quantidade">Quantidade</label>
                            <input type="number" id="quantidade" placeholder="Ex: 50" required>
                        </div>
                        <div class="input-group">
                            <label for="custoProduto">Custo do Produto</label>
                            <input type="text" class="currency" id="custoProduto" placeholder="Digite o valor" required>
                        </div>
                        <div class="input-group">
                            <label for="valorVenda">Valor de Venda</label>
                            <input type="text" class="currency" id="valorVenda" placeholder="Digite o valor" required>
                        </div>
                        <div class="input-group">
                            <label for="categoria">Categoria</label>
                            <div style="display: flex; gap: 10px;">
                                <select id="categoria" style="flex-grow: 1;">
                                </select>
                                <button type="button" id="open-category-modal" class="btn-warning" style="width: auto; padding: 0 15px;">
                                    <span class="material-icons-sharp">settings</span>
                                </button>
                            </div>
                        </div>
                        <div class="input-group" style="justify-content: flex-end;">
                            <button type="submit" class="btn-success">Cadastrar Produto</button>
                        </div>
                    </form>
                </div>

                <div class="card">
                    <h2>Itens em Estoque</h2>
                    <input type="text" class="search-bar" id="searchEstoque" placeholder="Pesquisar...">
                    <small class="search-instruction">Busque por nome, código, "vencendo" ou "repor".</small>
                    <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Código</th>
                                    <th>Produto</th>
                                    <th>Qtd.</th>
                                    <th>Custo</th>
                                    <th>Venda</th>
                                    <th>Lucro/Un.</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="tabela-estoque-body">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="vendas" class="main-content">
                <h1>Registrar Venda / Orçamento</h1>
                <div class="card">
                    <h2>Itens e Cliente</h2>
                    <div class="form-container" id="form-vendas">
                        <div class="input-group" style="grid-column: 1 / -1;">
                            <label for="nomeCliente">Nome do Cliente</label>
                            <input type="text" id="nomeCliente" placeholder="Opcional">
                        </div>

                        <div class="input-group">
                            <label for="selectProdutoVenda">Adicionar Produto</label>
                            <select id="selectProdutoVenda">
                                <option value="">Cadastre um item no estoque primeiro</option>
                            </select>
                        </div>
                        <div class="input-group">
                            <label for="quantidadeVenda">Quantidade</label>
                            <input type="number" id="quantidadeVenda" value="1" min="1">
                        </div>

                        <div class="input-group" style="grid-column: 1 / -1;">
                             <button type="button" id="addItemOrcamento" style="width: auto; padding: 10px 30px;">Adicionar ao Orçamento</button>
                        </div>
                    </div>

                    <h2 style="margin-top: 2rem;">Orçamento Atual</h2>
                     <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Produto</th>
                                    <th>Qtd.</th>
                                    <th>Preço Unit.</th>
                                    <th>Subtotal</th>
                                    <th>Ação</th>
                                </tr>
                            </thead>
                            <tbody id="orcamento-body">
                            </tbody>
                        </table>
                     </div>

                    <div style="text-align: right; margin-top: 1.5rem;">
                        <h3>Subtotal: <span id="subtotal-venda">R$ 0,00</span></h3>
                        <div style="display:inline-flex; align-items: center; gap: 10px; margin-top: 1rem;">
                            <label for="descontoVenda">Desconto (R$):</label>
                            <input type="text" class="currency" id="descontoVenda" style="width: 150px;" placeholder="0,00">
                        </div>
                        <h1 style="margin-top: 1rem;">Total: <span id="total-venda">R$ 0,00</span></h1>
                    </div>
                </div>

                <div class="card">
                    <h2>Finalizar</h2>
                    <div class="form-container">
                        <div class="input-group">
                            <label for="dataVenda">Data da Venda</label>
                            <input type="text" id="dataVenda" readonly>
                        </div>
                        <div class="input-group">
                            <label>Ações</label>
                            <div style="display: flex; gap: 1rem; flex-wrap: wrap;">
                               <button type="button" id="share-whatsapp" style="background-color: #25D366; display:flex; align-items: center; justify-content: center; gap: 0.5rem;">
                                    <span class="material-icons-sharp">share</span> WhatsApp
                                </button>
                                <button type="button" id="registrar-venda-btn" class="btn-success" style="display:flex; align-items: center; justify-content: center; gap: 0.5rem;">
                                    <span class="material-icons-sharp">check_circle</span> Registrar Venda
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="card">
                    <h2>Histórico de Vendas</h2>
                    <input type="text" class="search-bar" id="pesquisa-venda-cliente" placeholder="Pesquisar por nome do cliente...">
                     <div class="table-wrapper">
                        <table>
                            <thead>
                                <tr>
                                    <th>Cliente</th>
                                    <th>Data</th>
                                    <th>Itens Vendidos</th>
                                    <th>Valor Total</th>
                                </tr>
                            </thead>
                            <tbody id="historico-vendas-body">
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- Category Management Modal -->
    <div class="modal-overlay" id="category-modal">
        <div class="modal-container">
            <div class="modal-header">
                <h2>Gerenciar Categorias</h2>
                <button class="close-modal" id="close-category-modal">
                    <span class="material-icons-sharp">close</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="input-group">
                    <label for="nova-categoria-nome">Adicionar Nova Categoria</label>
                    <div style="display: flex; gap: 10px;">
                        <input type="text" id="nova-categoria-nome" placeholder="Nome da Categoria">
                        <button id="add-categoria-btn" class="btn-success" style="width: auto;">Adicionar</button>
                    </div>
                </div>
                <h3 style="margin-top: 2rem; margin-bottom: 1rem;">Categorias Existentes</h3>
                <ul id="lista-categorias">
                </ul>
            </div>
        </div>
    </div>

    <!-- Generic Notification/Confirmation Modal -->
    <div class="modal-overlay" id="app-notification-modal">
        <div class="modal-container" style="max-width: 400px;">
            <div class="modal-header">
                <h2 id="app-notification-title">Aviso</h2>
                <button class="close-modal" id="app-notification-close-btn">
                    <span class="material-icons-sharp">close</span>
                </button>
            </div>
            <div class="modal-body">
                <p id="app-notification-message" style="margin-bottom: 1.5rem;"></p>
                <div id="app-notification-buttons" style="display: flex; justify-content: flex-end; gap: 1rem;">
                    <!-- Buttons are dynamically injected here -->
                </div>
            </div>
        </div>
    </div>


    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyAv54tgJ5oYrwTSNXpB2rCGjNbhJhe2CoM",
            authDomain: "stolinx-d6e26.firebaseapp.com",
            projectId: "stolinx-d6e26",
            storageBucket: "stolinx-d6e26.appspot.com",
            messagingSenderId: "715535971682",
            appId: "1:715535971682:web:66620d1590ae3e4ba6a83b"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        let currentUserId = null; // Will hold the logged-in user's ID
        
        // --- AUTHENTICATION LOGIC ---
        
        const authContainer = document.getElementById('auth-container');
        const mainContainer = document.querySelector('.container');
        const loginForm = document.getElementById('login-form');
        const registerForm = document.getElementById('register-form');
        const authMessage = document.getElementById('auth-message');

        // Function to show authentication messages
        function showAuthMessage(message, type = 'error') {
            authMessage.textContent = message;
            authMessage.className = type; // 'error' or 'success'
            authMessage.style.display = 'block';
        }
        
        // Toggle between Login and Register forms
        document.getElementById('show-register').addEventListener('click', () => {
            loginForm.style.display = 'none';
            registerForm.style.display = 'block';
            authMessage.style.display = 'none';
        });

        document.getElementById('show-login').addEventListener('click', () => {
            registerForm.style.display = 'none';
            loginForm.style.display = 'block';
            authMessage.style.display = 'none';
        });

        // Handle Login
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;

            if (!email || !password) {
                showAuthMessage('Por favor, preencha todos os campos.');
                return;
            }

            auth.signInWithEmailAndPassword(email, password)
                .then(userCredential => {
                    showAuthMessage('Login bem-sucedido!', 'success');
                    // onAuthStateChanged will handle the UI switch
                })
                .catch(error => {
                    let message = 'Ocorreu um erro. Tente novamente.';
                    if (error.code === 'auth/user-not-found' || error.code === 'auth/wrong-password') {
                        message = 'E-mail ou senha incorretos.';
                    }
                    showAuthMessage(message);
                });
        });

        // Handle Registration
        registerForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const email = document.getElementById('register-email').value;
            const password = document.getElementById('register-password').value;
            
            if (!email || !password) {
                showAuthMessage('Por favor, preencha todos os campos.');
                return;
            }

            auth.createUserWithEmailAndPassword(email, password)
                .then(userCredential => {
                    showAuthMessage('Conta criada com sucesso! Você será redirecionado.', 'success');
                })
                .catch(error => {
                    let message = 'Ocorreu um erro ao criar a conta.';
                    if (error.code === 'auth/email-already-in-use') {
                        message = 'Este e-mail já está em uso.';
                    } else if (error.code === 'auth/weak-password') {
                        message = 'A senha deve ter pelo menos 6 caracteres.';
                    }
                    showAuthMessage(message);
                });
        });
        
        // Handle Google Sign-In
        document.getElementById('google-signin-btn').addEventListener('click', () => {
            const provider = new firebase.auth.GoogleAuthProvider();
            auth.signInWithPopup(provider)
                .then(result => {
                    showAuthMessage('Login com Google bem-sucedido!', 'success');
                })
                .catch(error => {
                    showAuthMessage('Erro ao fazer login com Google.');
                    console.error("Google Sign-in Error:", error);
                });
        });

        // Handle Logout
        document.getElementById('logout-btn').addEventListener('click', (e) => {
            e.preventDefault();
            auth.signOut();
        });

        // --- AUTH STATE OBSERVER ---
        
        auth.onAuthStateChanged(user => {
            if (user) {
                // User is signed in
                currentUserId = user.uid;
                authContainer.style.display = 'none';
                mainContainer.classList.add('visible');
                initializeAppLogic(); // Start the main application logic
            } else {
                // User is signed out
                currentUserId = null;
                mainContainer.classList.remove('visible');
                authContainer.style.display = 'flex';
                // Optional: Clear any sensitive data from the UI
                document.getElementById('tabela-estoque-body').innerHTML = '';
                document.getElementById('historico-vendas-body').innerHTML = '';
            }
        });
        
        // --- MAIN APPLICATION LOGIC ---
        
        // This function will only be called after a user logs in
        function initializeAppLogic() {
            // --- MODAL AND NOTIFICATION SETUP ---
            const notificationModal = document.getElementById('app-notification-modal');
            const notificationTitle = document.getElementById('app-notification-title');
            const notificationMessage = document.getElementById('app-notification-message');
            const notificationButtons = document.getElementById('app-notification-buttons');
            const notificationCloseBtn = document.getElementById('app-notification-close-btn');

            function closeNotificationModal() {
                notificationModal.style.display = 'none';
            }
            notificationCloseBtn.addEventListener('click', closeNotificationModal);
            notificationModal.addEventListener('click', (e) => {
                if (e.target === notificationModal) {
                    closeNotificationModal();
                }
            });

            function showAppNotification(message, title = 'Aviso') {
                notificationTitle.textContent = title;
                notificationMessage.textContent = message;
                notificationButtons.innerHTML = '<button id="notification-ok-btn" class="btn-success">OK</button>';
                notificationModal.style.display = 'flex';
                document.getElementById('notification-ok-btn').addEventListener('click', closeNotificationModal);
            }

            function showAppConfirmation(message, onConfirm, title = 'Confirmação') {
                notificationTitle.textContent = title;
                notificationMessage.textContent = message;
                notificationButtons.innerHTML = `
                    <button id="confirmation-cancel-btn">Cancelar</button>
                    <button id="confirmation-ok-btn" class="btn-danger">Confirmar</button>
                `;
                notificationModal.style.display = 'flex';
                document.getElementById('confirmation-ok-btn').addEventListener('click', () => {
                    if (typeof onConfirm === 'function') {
                        onConfirm();
                    }
                    closeNotificationModal();
                });
                document.getElementById('confirmation-cancel-btn').addEventListener('click', closeNotificationModal);
            }


            const menuBtn = document.getElementById('menu-btn');
            const closeBtn = document.getElementById('close-btn');
            const aside = document.querySelector('aside');
            const themeTogglerLink = document.getElementById('theme-toggler-link');

            menuBtn.addEventListener('click', () => {
                aside.classList.add('show-sidebar');
            });

            closeBtn.addEventListener('click', () => {
                aside.classList.remove('show-sidebar');
            });
            
            themeTogglerLink.addEventListener('click', (e) => {
                e.preventDefault();
                const isDark = document.body.classList.toggle('dark-theme');
                const iconSpan = themeTogglerLink.querySelector('span');
                
                iconSpan.textContent = isDark ? 'dark_mode' : 'light_mode';
                localStorage.setItem('darkMode', isDark ? 'enabled' : 'disabled');
            });

            if (localStorage.getItem('darkMode') === 'enabled') {
                document.body.classList.add('dark-theme');
                themeTogglerLink.querySelector('span').textContent = 'dark_mode';
            }
            
            const navLinks = document.querySelectorAll('.nav-link');
            const contentSections = document.querySelectorAll('.main-content');
            const mobilePageTitle = document.getElementById('mobile-page-title');

            navLinks.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    const targetId = link.getAttribute('data-target');
                    if (!targetId) return;

                    navLinks.forEach(l => l.classList.remove('active'));
                    contentSections.forEach(s => s.classList.remove('active'));
                    
                    link.classList.add('active');
                    document.getElementById(targetId).classList.add('active');
                    
                    mobilePageTitle.textContent = link.querySelector('h3').textContent;
                });
            });

            function setCurrentDate() {
                const today = new Date();
                const options = { year: 'numeric', month: 'long', day: 'numeric' };
                document.getElementById('current-date').textContent = today.toLocaleDateString('pt-BR', options);
                document.getElementById('dataVenda').value = today.toLocaleDateString('pt-BR');
            }

            function formatCurrency(input) {
                let value = input.value.replace(/\D/g, '');
                if (value === "") {
                    input.value = "";
                    return;
                }
                value = (parseInt(value, 10) / 100).toLocaleString('pt-BR', { minimumFractionDigits: 2 });
                input.value = value;
            }
            
            document.querySelectorAll('.currency').forEach(input => {
                input.addEventListener('input', () => formatCurrency(input));
            });
            
            const categoryModal = document.getElementById('category-modal');
            const openModalBtn = document.getElementById('open-category-modal');
            const closeModalBtn = document.getElementById('close-category-modal');
            const addCategoriaBtn = document.getElementById('add-categoria-btn');

            openModalBtn.addEventListener('click', () => {
                categoryModal.style.display = 'flex';
            });
            closeModalBtn.addEventListener('click', () => {
                categoryModal.style.display = 'none';
            });
            categoryModal.addEventListener('click', (e) => {
                if (e.target === categoryModal) {
                    categoryModal.style.display = 'none';
                }
            });

            // Helper to get user-specific collection
            const getUserCollection = (collectionName) => {
                if (!currentUserId) throw new Error("User not logged in!");
                return db.collection('users').doc(currentUserId).collection(collectionName);
            }

            addCategoriaBtn.addEventListener('click', () => {
                const nomeInput = document.getElementById('nova-categoria-nome');
                const nomeCategoria = nomeInput.value.trim();
                if (nomeCategoria === "") {
                    showAppNotification('Por favor, digite um nome para a categoria.');
                    return;
                }
                getUserCollection("categorias").add({ nome: nomeCategoria })
                    .then(() => { nomeInput.value = ""; })
                    .catch(error => { console.error("Erro ao adicionar categoria: ", error); });
            });

            const formCadastro = document.getElementById('form-cadastro-produto');
            formCadastro.addEventListener('submit', (e) => {
                e.preventDefault();

                const produto = {
                    codigo: formCadastro.codigoProduto.value,
                    nome: formCadastro.nomeProduto.value,
                    validade: formCadastro.validade.value,
                    quantidade: parseInt(formCadastro.quantidade.value),
                    custo: parseFloat(formCadastro.custoProduto.value.replace(/\./g, '').replace(',', '.')),
                    valorVenda: parseFloat(formCadastro.valorVenda.value.replace(/\./g, '').replace(',', '.')),
                    categoria: formCadastro.categoria.value,
                };
                produto.lucroUnidade = produto.valorVenda - produto.custo;

                const editId = formCadastro.editProductId.value;

                if (editId) {
                    getUserCollection("produtos").doc(editId).update(produto)
                        .then(() => {
                            showAppNotification("Produto atualizado com sucesso!", "Sucesso");
                            formCadastro.reset();
                            formCadastro.editProductId.value = '';
                            formCadastro.querySelector('button[type="submit"]').textContent = 'Cadastrar Produto';
                        })
                        .catch((error) => {
                            console.error("Erro ao atualizar: ", error);
                            showAppNotification("Falha ao atualizar produto.");
                        });
                } else {
                    // Add creation timestamp for new products
                    produto.createdAt = firebase.firestore.FieldValue.serverTimestamp();
                    getUserCollection("produtos").add(produto)
                        .then(() => {
                            showAppNotification("Produto cadastrado com sucesso!", "Sucesso");
                            formCadastro.reset();
                        })
                        .catch((error) => {
                            console.error("Erro ao cadastrar: ", error);
                            showAppNotification("Falha ao cadastrar produto.");
                        });
                }
            });

            function carregarCategorias() {
                const selectCategoria = document.getElementById('categoria');
                const listaCategoriasUl = document.getElementById('lista-categorias');

                getUserCollection("categorias").orderBy("nome").onSnapshot(snapshot => {
                    selectCategoria.innerHTML = "";
                    listaCategoriasUl.innerHTML = "";
                    if (snapshot.empty) {
                        selectCategoria.innerHTML = '<option>Nenhuma categoria</option>';
                        listaCategoriasUl.innerHTML = '<li>Nenhuma categoria cadastrada.</li>';
                        return;
                    }
                    snapshot.forEach(doc => {
                        const categoria = doc.data();
                        const option = document.createElement('option');
                        option.value = categoria.nome;
                        option.textContent = categoria.nome;
                        selectCategoria.appendChild(option);

                        const li = document.createElement('li');
                        li.innerHTML = `
                            <span>${categoria.nome}</span>
                            <div class="action-buttons">
                                <button class="btn-danger" onclick="window.excluirCategoria('${doc.id}', '${categoria.nome}')">
                                    <span class="material-icons-sharp">delete</span>
                                </button>
                            </div>
                        `;
                        listaCategoriasUl.appendChild(li);
                    });
                }, error => {
                    console.error("Firestore read error on categories:", error);
                    showAppNotification("Erro ao carregar categorias. Verifique suas regras de segurança no Firebase.");
                });
            }
            
            window.excluirCategoria = (id, nome) => {
                const onConfirm = () => {
                    getUserCollection("categorias").doc(id).delete().catch(error => {
                        console.error("Erro ao excluir categoria: ", error);
                        showAppNotification("Erro ao excluir categoria.");
                    });
                };
                showAppConfirmation(`Tem certeza que deseja excluir a categoria "${nome}"?`, onConfirm);
            }

            window.editarProduto = (id) => {
                const form = document.getElementById('form-cadastro-produto');
                getUserCollection('produtos').doc(id).get().then(doc => {
                    if (doc.exists) {
                        const produto = doc.data();
                        form.editProductId.value = id;
                        form.codigoProduto.value = produto.codigo;
                        form.nomeProduto.value = produto.nome;
                        form.validade.value = produto.validade;
                        form.quantidade.value = produto.quantidade;
                        form.custoProduto.value = produto.custo.toLocaleString('pt-BR', { minimumFractionDigits: 2 });
                        form.valorVenda.value = produto.valorVenda.toLocaleString('pt-BR', { minimumFractionDigits: 2 });
                        form.categoria.value = produto.categoria;
                        
                        form.querySelector('button[type="submit"]').textContent = 'Salvar Alterações';
                        form.scrollIntoView({ behavior: 'smooth' });

                    } else {
                        showAppNotification("Produto não encontrado!");
                    }
                }).catch(error => {
                    console.error("Erro ao buscar produto para edição:", error);
                });
            }

            function carregarProdutos() {
                const tabelaCorpo = document.getElementById("tabela-estoque-body");
                const selectVenda = document.getElementById('selectProdutoVenda');

                getUserCollection("produtos").orderBy("nome").onSnapshot((querySnapshot) => {
                    tabelaCorpo.innerHTML = '';
                    selectVenda.innerHTML = '<option value="">Selecione um item do estoque</option>';
                    
                    if (querySnapshot.empty) {
                        tabelaCorpo.innerHTML = '<tr><td colspan="7">Nenhum produto cadastrado.</td></tr>';
                        return;
                    }

                    const hoje = new Date();
                    hoje.setHours(0, 0, 0, 0);

                    querySnapshot.forEach((doc) => {
                        const produto = doc.data();
                        const lucroUnidade = produto.lucroUnidade || (produto.valorVenda - produto.custo);
                        const tr = document.createElement('tr');
                        
                        let avisoVencimento = '';
                        let classeVencimento = '';

                        if (produto.validade) {
                            const [ano, mes, dia] = produto.validade.split('-').map(Number);
                            const dataValidade = new Date(ano, mes - 1, dia);
                            const diffTime = dataValidade.getTime() - hoje.getTime();
                            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                            if (diffDays >= 0 && diffDays <= 30) {
                                classeVencimento = 'vencimento-proximo';
                                avisoVencimento = `<span class="material-icons-sharp vencimento-aviso-icon" title="Vence em ${diffDays} dias!">warning</span>`;
                            }
                        }
                        
                        tr.className = classeVencimento;

                        tr.innerHTML = `
                            <td>${produto.codigo}</td>
                            <td>${produto.nome} ${avisoVencimento}</td>
                            <td class="${produto.quantidade < 3 ? 'low-stock-warning' : ''}">${produto.quantidade} ${produto.quantidade < 3 ? ' (Repor!)' : ''}</td>
                            <td>R$ ${produto.custo.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                            <td>R$ ${produto.valorVenda.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                            <td>R$ ${lucroUnidade.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                            <td class="action-buttons">
                                <button class="btn-warning" onclick="window.editarProduto('${doc.id}')"><span class="material-icons-sharp">edit</span></button>
                                <button class="btn-danger" onclick="window.excluirProduto('${doc.id}', '${produto.nome}')"><span class="material-icons-sharp">delete</span></button>
                            </td>
                        `;
                        tabelaCorpo.appendChild(tr);

                        if (produto.quantidade > 0) {
                            const option = document.createElement('option');
                            option.value = doc.id;
                            option.textContent = `${produto.nome} (Estoque: ${produto.quantidade}) - R$ ${produto.valorVenda.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                            option.dataset.price = produto.valorVenda;
                            option.dataset.cost = produto.custo;
                            option.dataset.name = produto.nome;
                            selectVenda.appendChild(option);
                        }
                    });
                });
            }

            window.excluirProduto = (id, nome) => {
                const onConfirm = () => {
                    getUserCollection("produtos").doc(id).delete().then(() => {
                        showAppNotification("Produto excluído com sucesso!", "Sucesso");
                    }).catch((error) => {
                        console.error("Erro ao excluir: ", error);
                        showAppNotification("Falha ao excluir produto.");
                    });
                };
                showAppConfirmation(`Tem certeza que deseja excluir o produto "${nome}"?`, onConfirm);
            }

            let orcamento = [];
            const btnRegistrarVenda = document.getElementById('registrar-venda-btn');

            document.getElementById('addItemOrcamento').addEventListener('click', () => {
                const select = document.getElementById('selectProdutoVenda');
                const produtoId = select.value;
                if (!produtoId) return;

                const selectedOption = select.options[select.selectedIndex];
                const produtoNome = selectedOption.dataset.name;
                const produtoPreco = parseFloat(selectedOption.dataset.price);
                const produtoCusto = parseFloat(selectedOption.dataset.cost);
                const quantidade = parseInt(document.getElementById('quantidadeVenda').value);

                orcamento.push({ id: produtoId, nome: produtoNome, qtd: quantidade, preco: produtoPreco, custo: produtoCusto });
                atualizarTabelaOrcamento();
            });
            
            function atualizarTabelaOrcamento() {
                const orcamentoBody = document.getElementById('orcamento-body');
                orcamentoBody.innerHTML = '';
                let subtotal = 0;

                orcamento.forEach((item, index) => {
                    const itemSubtotal = item.qtd * item.preco;
                    subtotal += itemSubtotal;
                    const tr = document.createElement('tr');
                    tr.innerHTML = `
                        <td>${item.nome}</td>
                        <td>${item.qtd}</td>
                        <td>R$ ${item.preco.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                        <td>R$ ${itemSubtotal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                        <td class="action-buttons">
                            <button class="btn-danger" onclick="window.removerItemOrcamento(${index})"><span class="material-icons-sharp">close</span></button>
                        </td>
                    `;
                    orcamentoBody.appendChild(tr);
                });

                const descontoInput = document.getElementById('descontoVenda');
                const descontoValor = parseFloat(descontoInput.value.replace(/\./g, '').replace(',', '.')) || 0;
                const total = subtotal - descontoValor;

                document.getElementById('subtotal-venda').textContent = `R$ ${subtotal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                document.getElementById('total-venda').textContent = `R$ ${total.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            }

            window.removerItemOrcamento = (index) => {
                orcamento.splice(index, 1);
                atualizarTabelaOrcamento();
            }
            
            document.getElementById('descontoVenda').addEventListener('input', atualizarTabelaOrcamento);

            document.getElementById('share-whatsapp').addEventListener('click', () => {
                if (orcamento.length === 0) {
                    showAppNotification('Adicione pelo menos um item ao orçamento para compartilhar.');
                    return;
                }
                let cliente = document.getElementById('nomeCliente').value || 'Cliente';
                let total = document.getElementById('total-venda').innerText;
                
                let texto = `*Orçamento para ${cliente}*\n\n`;
                orcamento.forEach(item => {
                    texto += `- ${item.qtd}x ${item.nome}: R$ ${(item.qtd * item.preco).toLocaleString('pt-BR', {minimumFractionDigits: 2})}\n`;
                });
                texto += `\n*Total: ${total}*`;

                const url = `https://wa.me/?text=${encodeURIComponent(texto)}`;
                window.open(url, '_blank');
            });

            btnRegistrarVenda.addEventListener('click', () => {
                if (orcamento.length === 0) {
                    showAppNotification('Adicione pelo menos um item para registrar a venda.');
                    return;
                }

                const totalVenda = parseFloat(document.getElementById('total-venda').textContent.replace('R$ ', '').replace(/\./g, '').replace(',', '.'));
                const custoTotalVenda = orcamento.reduce((total, item) => total + (item.custo * item.qtd), 0);
                const lucroVenda = totalVenda - custoTotalVenda;

                const venda = {
                    cliente: document.getElementById('nomeCliente').value || 'Não informado',
                    data: firebase.firestore.FieldValue.serverTimestamp(),
                    itens: orcamento,
                    subtotal: parseFloat(document.getElementById('subtotal-venda').textContent.replace('R$ ', '').replace(/\./g, '').replace(',', '.')),
                    desconto: parseFloat(document.getElementById('descontoVenda').value.replace(/\./g, '').replace(',', '.')) || 0,
                    total: totalVenda,
                    lucro: lucroVenda
                };

                const batch = db.batch();
                const vendaRef = getUserCollection('vendas').doc();
                batch.set(vendaRef, venda);

                orcamento.forEach(item => {
                    const produtoRef = getUserCollection('produtos').doc(item.id);
                    batch.update(produtoRef, {
                        quantidade: firebase.firestore.FieldValue.increment(-item.qtd)
                    });
                });

                batch.commit().then(() => {
                    showAppNotification('Venda registrada com sucesso!', 'Sucesso');
                    orcamento = [];
                    document.getElementById('nomeCliente').value = '';
                    document.getElementById('descontoVenda').value = '';
                    atualizarTabelaOrcamento();
                }).catch(error => {
                    console.error('Erro ao registrar a venda: ', error);
                    showAppNotification('Ocorreu um erro ao registrar a venda. Verifique o console para mais detalhes.');
                });
            });

            const pesquisaVendaInput = document.getElementById('pesquisa-venda-cliente');
            let todasAsVendas = [];

            function carregarHistoricoVendas() {
                getUserCollection('vendas').onSnapshot(snapshot => {
                    todasAsVendas = [];
                    snapshot.forEach(doc => {
                        todasAsVendas.push(doc.data());
                    });

                    todasAsVendas.sort((a, b) => {
                        const dateA = a.data ? a.data.toMillis() : 0;
                        const dateB = b.data ? b.data.toMillis() : 0;
                        return dateB - dateA;
                    });

                    renderizarVendas(todasAsVendas);
                }, error => {
                    console.error("Erro ao carregar histórico de vendas: ", error);
                });
            }

            function renderizarVendas(vendasParaRenderizar) {
                const tabelaCorpo = document.getElementById('historico-vendas-body');
                tabelaCorpo.innerHTML = '';

                if (vendasParaRenderizar.length === 0) {
                    tabelaCorpo.innerHTML = '<tr><td colspan="4">Nenhuma venda encontrada.</td></tr>';
                    return;
                }

                vendasParaRenderizar.forEach(venda => {
                    const tr = document.createElement('tr');
                    let dataFormatada = 'Processando...';
                    if (venda.data && venda.data.toDate) {
                        dataFormatada = venda.data.toDate().toLocaleDateString('pt-BR');
                    }
                    const itensFormatados = venda.itens.map(item => `${item.qtd}x ${item.nome}`).join(', ');
                    
                    tr.innerHTML = `
                        <td>${venda.cliente}</td>
                        <td>${dataFormatada}</td>
                        <td>${itensFormatados}</td>
                        <td>R$ ${venda.total.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                    `;
                    tabelaCorpo.appendChild(tr);
                });
            }
            
            pesquisaVendaInput.addEventListener('input', () => {
                const termoBusca = pesquisaVendaInput.value.toLowerCase().trim();
                if (termoBusca === '') {
                    renderizarVendas(todasAsVendas);
                } else {
                    const vendasFiltradas = todasAsVendas.filter(venda => 
                        venda.cliente.toLowerCase().includes(termoBusca)
                    );
                    renderizarVendas(vendasFiltradas);
                }
            });

            document.getElementById('searchEstoque').addEventListener('keyup', () => {
                const filtro = document.getElementById('searchEstoque').value.toUpperCase();
                const tabelaCorpo = document.getElementById("tabela-estoque-body");
                const linhas = tabelaCorpo.getElementsByTagName("tr");

                for (let i = 0; i < linhas.length; i++) {
                    const linha = linhas[i];
                    const celulas = linha.getElementsByTagName("td");
                    let exibirLinha = false;

                    if (celulas.length > 1) {
                        const codigoProduto = celulas[0].textContent || celulas[0].innerText;
                        const nomeProduto = celulas[1].textContent || celulas[1].innerText;
                        
                        if (codigoProduto.toUpperCase().indexOf(filtro) > -1 || nomeProduto.toUpperCase().indexOf(filtro) > -1) {
                            exibirLinha = true;
                        }

                        if ("VENCENDO".indexOf(filtro) > -1 && linha.classList.contains('vencimento-proximo')) {
                            exibirLinha = true;
                        }

                        const quantidadeTexto = celulas[2].textContent || celulas[2].innerText;
                        if ("REPOR".indexOf(filtro) > -1 && quantidadeTexto.toUpperCase().includes('REPOR')) {
                             exibirLinha = true;
                        }
                        
                        if (exibirLinha) {
                            linha.style.display = "";
                        } else {
                            linha.style.display = "none";
                        }
                    }
                }
            });

            let salesChartInstance;
            function atualizarDashboard() {
                const faturamentoEl = document.getElementById('faturamento-mes');
                const investimentoEl = document.getElementById('investimento-mes');
                const lucroEl = document.getElementById('lucro-mes');
                const topSellersBody = document.getElementById('produtos-mais-saida-body');

                // --- CALCULA INVESTIMENTO TOTAL E LUCRO POTENCIAL DO ESTOQUE ATUAL ---
                getUserCollection('produtos').onSnapshot(snapshot => {
                    let investimentoTotal = 0;
                    let lucroPotencialTotal = 0;
                    snapshot.forEach(doc => {
                        const p = doc.data();
                        investimentoTotal += (p.custo || 0) * (p.quantidade || 0);
                        lucroPotencialTotal += (p.valorVenda - p.custo) * (p.quantidade || 0);
                    });
                    investimentoEl.textContent = `R$ ${investimentoTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                    lucroEl.textContent = `R$ ${lucroPotencialTotal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
                }, error => {
                     console.error("Erro ao buscar produtos para o dashboard:", error);
                     investimentoEl.textContent = 'Erro';
                     lucroEl.textContent = 'Erro';
                });

                // --- CALCULA FATURAMENTO E ITENS MAIS VENDIDOS DO MÊS ATUAL ---
                const hoje = new Date();
                const primeiroDiaDoMes = new Date(hoje.getFullYear(), hoje.getMonth(), 1);
                const ultimoDiaDoMes = new Date(hoje.getFullYear(), hoje.getMonth() + 1, 0, 23, 59, 59);

                getUserCollection('vendas')
                    .where('data', '>=', primeiroDiaDoMes)
                    .where('data', '<=', ultimoDiaDoMes)
                    .onSnapshot(snapshot => {
                        let faturamentoMensal = 0;
                        const topSellers = {};

                        snapshot.forEach(doc => {
                            const v = doc.data();
                            faturamentoMensal += v.total || 0;

                            if (v.itens) {
                                v.itens.forEach(item => {
                                    topSellers[item.nome] = (topSellers[item.nome] || 0) + item.qtd;
                                });
                            }
                        });

                        faturamentoEl.textContent = `R$ ${faturamentoMensal.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;

                        const sortedTopSellers = Object.entries(topSellers).sort((a, b) => b[1] - a[1]);
                        
                        topSellersBody.innerHTML = '';
                        if (sortedTopSellers.length === 0) {
                            topSellersBody.innerHTML = '<tr><td colspan="2">Nenhuma venda este mês.</td></tr>';
                        } else {
                            sortedTopSellers.slice(0, 5).forEach(([nome, quantidade]) => {
                                const tr = document.createElement('tr');
                                tr.innerHTML = `<td>${nome}</td><td>${quantidade}</td>`;
                                topSellersBody.appendChild(tr);
                            });
                        }
                        renderProductPieChart(sortedTopSellers);
                    });
            }
            
            function renderProductPieChart(topSellersData) {
                const ctx = document.getElementById('salesChart').getContext('2d');
                
                const labels = topSellersData.map(item => item[0]);
                const data = topSellersData.map(item => item[1]);

                if (salesChartInstance) {
                    salesChartInstance.destroy();
                }

                salesChartInstance = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Unidades Vendidas',
                            data: data,
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.7)',
                                'rgba(54, 162, 235, 0.7)',
                                'rgba(255, 206, 86, 0.7)',
                                'rgba(75, 192, 192, 0.7)',
                                'rgba(153, 102, 255, 0.7)',
                                'rgba(255, 159, 64, 0.7)'
                            ],
                            borderColor: [
                                'rgba(255, 255, 255, 1)'
                            ],
                            borderWidth: 2
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            title: {
                                display: false
                            }
                        }
                    }
                });
            }
            
            // --- INITIALIZATION ---
            setCurrentDate();
            carregarProdutos();
            carregarCategorias();
            carregarHistoricoVendas();
            atualizarDashboard();
        }
    </script>
</body>
</html>
